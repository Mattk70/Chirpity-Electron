<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https:">
    <!-- Bootstrap & CSS-->
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <script defer src="./node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <script defer src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Additional JavaScript & CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <script defer src="./node_modules/@easepick/bundle/dist/index.umd.js"></script>
    <script defer src="./js/components/slider.js"></script>
    <script defer src="./node_modules/chart.js/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script>
        function goFullscreen(){
            const container = document.getElementById('chart-week');
            container.requestFullscreen();
        }


    </script>
    <!-- App title -->
    <title>Chirpity</title>
</head>
<body background="#ccccc">
    <!-- Content wrapper -->


<div 
    id="loading-screen" 
    role="progressbar" 
    aria-busy="true" 
    aria-label="Loading application">
    <div id="loading-panel" class="border border-success">
        <img src="img/icon/chirpity_logo.png" height="40px" alt="Chirpity Logo">
        <span id="loading-text" aria-live="polite">Getting things ready...</span>
        <div class="spinner-border text-success m-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<div id="contentWrapper">
    <!-- Explore Div -->
    <div id="exploreWrapper" class="p-2 row d-none justify-content-evenly">
        <div class="col align-middle">
            <div class="btn btn-light me-2 pt-3" id="exploreRange">
                <span class="material-symbols-outlined align-bottom">date_range</span>&nbsp;
                <span id="explore-datefilter">Apply a date filter</span> <span class="material-symbols-outlined float-end">expand_more</span>
            </div>
        </div>
        <div class="col"> 
            <div class="form-floating bird-search">
                <input type="text" class="form-control autocomplete" id="bird-autocomplete-explore" placeholder="Type to search...">
                <span class="input-caret"></span>
                <label class="species-search-label" for="bird-autocomplete-explore">Species Search</label>
                <ul id="bird-suggestions-explore" class="suggestions list-group"></ul>
            </div>
        </div>
        <div class="col">
            <div id="explore-location-list" class="form-floating">
                <select spellcheck="false" class="input form-select" aria-label=".form-select"
                id="explore-locations"></select>
                <label for="explore-locations">Location</label>
            </div>
        </div>
    </div>
    
            <!-- Spectrogram view -->
            <div class="w-100 d-none" id="spectrogramWrapper">
                <div>
                    <div class="w-100" id="spectrogram"></div>
                    <div class="w-100" id="waveform"></div>
                </div>
                <!-- Controls view -->
                <div class="container-fluid p-1 text-bg-dark d-inline-flex" id="controlsWrapper" style="max-height: 50px" title="Drag to resize the Spectrogram window.">
                    <a id="metadata" class="pointer pt-2 d-none" tabindex="-1" data-bs-custom-class="metadata-popover" data-bs-html="true" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="File Metadata">
                        <span class="material-symbols-outlined"  title="Display File Metadata">other_admission</span></a>
                    <div id="filename" class="col-auto ps-1 overflow-visible flex-nowrap"></div>
                    <div id="unsaved-icon" class="material-symbols-outlined ms-2 me-2 text-warning pointer d-none"  tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Unsaved Edits" data-bs-content="There are changes to the results that haven't been saved.">warning</div>
                    <div class="col-auto btn-group bg-dark pt-0 p-1 ms-2 me-2 text-nowrap" role="group">
                        <button id="playToggle" class="p-1 pe-2 btn btn-outline-secondary" title="Play / Pause (SpaceBar)">
                            <span class="material-symbols-outlined ">play_circle</span>
                            <span class="align-middle d-none d-lg-inline-block"> Play </span>
                            /
                            <span class="material-symbols-outlined">pause</span>
                            <span class="align-middle d-none d-lg-inline-block">Pause</span>
                        </button>
                    </div>
                    <div class="col-auto btn-group bg-dark pt-0 p-1 pe-2" role="group">
                        <button id="zoomIn" title="Zoom into the spectrogram (Keyboard Shortcut: + key)" class="btn btn-outline-secondary"
                        style="min-width: 3rem">
                        <span class="material-symbols-outlined zoom translate-middle">zoom_in</span>
                        </button>
                        <button id="zoomOut" title="Zoom out of the spectrogram (Keyboard Shortcut: - key)" class="btn btn-outline-secondary"
                            style="min-width: 3rem"><span class="material-symbols-outlined zoom  translate-middle">zoom_out</span>
                        </button>
                    </div>
            <div class="col pe-1">
                <div class="btn-group-rounded position-relative float-end" id="filter-panel">
                    <span style="max-width: 70px" id="model-icon" class="btn btn-outline-secondary p-1 d-none">
                        <img class="icon" src="img/icon/birdnet_logo.png" alt="BirdNET">
                    </span>
                    <span style="max-width: 70px" title="Nocmig mode on" id="nocmigMode"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">nights_stay</span>
                    <span style="max-width: 70px" id="audioFiltersIcon" title="Audio filters applied"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">blur_on</span>
                    <span style="max-width: 70px" id="context-mode" title="Context Aware mode enabled"
                    class="chirpity-only material-symbols-outlined btn btn-outline-secondary p-1 pt-2">swap_horiz</span>
                    <span title="Adjust spectrogram frequency range" id="frequency-range"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">vertical_align_center</span>
                    <span style="max-width: 70px" id="list-icon" class="btn btn-outline-secondary p-1"><img
                        class="icon filter" src="img/nocturnal.png" alt="nocturnal"></span>
                        <span style="max-width: 70px" title="Prediction confidence threshold" id="threshold-value"
                        class="btn btn-outline-secondary p-1 fs-5"><b>50%</b>
                    </span>
                    <span id="confidenceSliderContainer" class="d-none">
                        <label for="confidenceValue" class="visually-hidden">confidence</label><input type="range"
                        class="form-range vertical position-absolute" step="5" min="5" id="confidenceValue">
                    </span>
                </div>
            </div>
        </div>
    </div>
    <!-- Result container -->
    <div class="d-none" id="resultTableContainer">
        <div class="row g-0 h-100">
            <div class="col-auto h-100 overflow-auto" id="summary">
                <!-- Summary table -->
                <div id="summaryTable"></div>
            </div>
                    <!-- Resizable divider -->
        <div id="divider"></div>
            <!-- Results table -->
            <div class="col ps-1 pe-0 h-100 position-relative overflow-auto" id="resultsDiv">
                <table id="results" class="text-center table w-100 align-middle">
                    <thead id="resultsHead" class="text-bg-secondary d-none"></thead>
                    <tbody class="text-dark" id="resultTableBody"></tbody>
                </table>
                <nav aria-label="Identification results">
                    <ul class="m-2 pagination justify-content-center"></ul>
                </nav>
            </div>
        </div>
    </div>
    <!-- Diagnostic Modal -->
    <div class="modal fade" id="diagnosticsModal" tabindex="-1" aria-labelledby="diagnosticsModalLabel" aria-modal="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="diagnosticsModalLabel">Diagnostic Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="diagnosticsModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>  
    <!-- Record Entry Modal -->
    <div class="modal fade" id="record-entry-modal" tabindex="-1" aria-labelledby="record-entry-modal-label" aria-modal="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content  overflow-visible">
                <div class="modal-header">
                    <h5 class="modal-title" id="record-entry-modal-label">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="record-entry-form">
                    <div id="record-entry-modal-body" class="modal-body overflow-visible">
                        <div class="row pe-3">
                            <div class="col-7">
                                <div class="mb-3"> 
                                    <!-- <input type="text" class="form-control mb-3" id="bird-search"> -->
                                    <div class="form-floating bird-search">
                                        <!-- Bootstrap-styled input -->
                                        <input type="text" class="form-control autocomplete" id="bird-autocomplete" placeholder="Type to search...">
                                        <!-- Caret rendered inside the input -->
                                        <span class="input-caret"></span>
                                        <!-- Suggestion list styled as a Bootstrap list group -->
                                        <label class="species-search-label" for="bird-autocomplete">Species Search</label>
                                        <ul id="bird-suggestions" class="suggestions list-group"></ul>
                                    </div>
                                    
                                </div>
                            </div>
                            <div class="col-5 border rounded ps-2 mb-3">
                                <label for="record-label" class="text-muted" style="font-size: .75em">Call Type</label>
                                <div id="label-container"></div>
                            </div>

                        </div>

                        <div class="border bg-light rounded mb-3 p-3" id="selected-bird"></div>

                        <div class="col hide-in-batch">
                            <div class="form-floating mb-3">
                                <input type="number" id="call-count" class="form-control" min="1">
                                <label class="mb-2" for="call-count">Call Count</label>
                            </div>
                        </div>
                        <div class="form-floating mt-3 hide-in-batch">
                            <textarea class="form-control" id="record-comment" style="height: 100px"></textarea>
                            <label for="record-comment">Comments</label>
                            <input type="hidden" id="DBmode">
                            <input type="hidden" id="batch-mode">
                            <input type="hidden" id="original-id">
                            <input type="hidden" id="original-modelID">
                            <input type="hidden" id="original-score">
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id="record-add" type="submit" class="btn btn-success">Add</button>
                        <button id="record-dismiss" type="button" class="btn btn-danger" data-bs-dismiss="modal">Dismiss</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Training Modal -->
    <div class="modal fade" id="training-modal" tabindex="-1" aria-labelledby="training-modal-label" aria-modal="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content  overflow-visible">
                <div class="modal-header">
                    <h5 class="modal-title" id="training-modal-label">Model Training Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="training-form">
                    <div id="training-modal-body" style="max-height: 60vh" class="modal-body">
                        <div class="row pb-3">
                            <div class="input-group">
                                <button class="btn btn-secondary col-5" type="button" id="dataset-location-select">
                                    Training Audio Location:</button>
                                <input type="text" style="font-size: 0.85rem;" class="form-control col-7" id="dataset-location" aria-describedby="dataset-location-select" placeholder="Location of the training files" readonly required>
                            </div>
                        </div>
                        <div class="row pb-1">
                            <div class="input-group">
                                <button class="btn btn-secondary col-5" type="button" id="dataset-cache-location-select">
                                    Dataset Cache Location:</button>
                                <input type="text" style="font-size: 0.85rem" class="form-control col-7" id="dataset-cache-location" aria-describedby="dataset-cache-location-select" placeholder="Location of the dataset cache" readonly>
                            </div>
                        </div>
                        <fieldset class="border rounded p-1 mb-3">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" role="switch" name="useCache" id="useCache">
                                <label class="form-check-label" for="useCache">Use the cached dataset if it exists</label>
                            </div>
                        </fieldset>
                        <div class="row pb-1">
                            <div class="input-group">
                                <button class="btn btn-secondary col-5" type="button" id="model-location-select">
                                    Model Save Location:</button>
                                <input type="text" style="font-size: 0.85rem;" class="form-control col-7" id="model-location" aria-describedby="model-location-select" placeholder="Location to save the model" readonly required>
                            </div>
                        </div>
                        <fieldset class="border rounded p-1 mb-3">
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label" for="replace">Replace labels</label>
                                    <input class="form-check-input" type="radio" name="model-type" id="replace" value="replace" checked>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="model-type" id="append" value="append">
                                    <label class="form-check-label" for="append">Append labels</label>
                                </div>
                        </fieldset>
                        <fieldset class="border rounded p-1">
                            <legend class="h6" id="training-parameters-title">Training parameters</legend>
                            <div class="row ps-2">
                                <div class="form-floating ps-1 col">
                                    <input type="number" id="epochs" class="form-control" min="1" max="300" value="10" required>
                                    <label class="mb-2" for="epochs">Training Epochs</label>
                                </div>
                                <div class="form-floating ps-1 col">
                                    <input type="number" id="lr" class="form-control" step="0.00001" min="0.00001" max="0.01" value="0.00001">
                                    <label class="mb-2" for="lr">Learning Rate</label>
                                </div>
                                <div class="form-floating ps-1 col">
                                    <input type="number" id="label-smoothing" class="form-control" step="0.01" min="0.0" max="0.5" value="0">
                                    <label class="mb-2" for="label-smoothing">Label Smoothing</label>
                                </div>
                            </div>
                            <div class="row mt-2 g-0 border rounded">
                                <div class="col ps-1">
                                    <div class="form-check form-switch ms-1">
                                        <input class="form-check-input" type="checkbox" role="switch" name="focal" id="focal">
                                        <label class="form-check-label" for="focal">Use focal loss</label>
                                    </div>
                                    <div class="form-check form-switch ms-1">
                                        <input class="form-check-input" type="checkbox" role="switch" name="weights" id="weights">
                                        <label class="form-check-label" for="weights">Use class weights</label>
                                    </div>
                                </div>
                                <div class="form-check form-switch col ms-1">
                                    <input class="form-check-input" type="checkbox" role="switch" name="decay" id="decay">
                                    <label class="form-check-label" for="decay">Use learning rate decay</label>
                                </div>
                                
                            </div>
                            <div class="ms-1">
                                <div class="input-group rounded pt-2">
                                    <label class="input-group-text" for="validation-split">Validation split:</label>
                                    <select class="form-select mb-0" id="validation-split">
                                        <option value="0">None</option>
                                        <option value="0.1">10%</option>
                                        <option value="0.2" selected>20%</option>
                                    </select>
                                </div>

                            </div>
                            <legend class="h6 pt-2" id="augmentations-title">Augmentations</legend>
                            <fieldset class="border rounded p-1">
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox" role="switch" name="mixup" id="mixup">
                                    <label class="form-check-label" for="mixup">Mixup</label>
                                </div>
                                <div class="form-check form-switch d-inline-block ms-3">
                                    <input class="form-check-input" type="checkbox" role="switch" name="use-noise" id="use-noise">
                                    <label class="form-check-label" for="use-noise">Mix in background noise</label>
                                </div>
                            </fieldset>
                            <legend class="h6 pt-2" id="classifier-title">Classifier</legend>
                            <div class="row">
                                <div class="input-group rounded mb-3 col">
                                    <label class="ps-1 input-group-text" for="hidden-units">Hidden units:</label>
                                    <select class="form-select mb-0" id="hidden-units">
                                        <option value="0" selected>0</option>
                                        <option value="128">128</option>
                                        <option value="256">256</option>
                                        <option value="512">512</option>
                                        <option value="1024">1024</option>
                                    </select>
                                </div>
                                <div class="input-group rounded mb-3 col">
                                    <label class="ps-1 input-group-text" for="dropout">Dropout rate:</label>
                                    <select class="form-select mb-0" id="dropout">
                                        <option value="0" selected>0</option>
                                        <option value="0.25">0.25</option>
                                        <option value="0.33">0.33</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.75">0.75</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id="train" type="submit" class="btn btn-success">Start training</button>
                        <button id="training-dismiss" type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Model import modal-->
    <div class="modal fade" id="import-modal" tabindex="-1" aria-labelledby="import-modal-label" aria-modal="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-modal-label">Import Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="import-form">
                    <div id="import-modal-body" class="modal-body">
                        <div class="pb-3">
                            <div class="input-group">
                                <button class="btn btn-secondary input-group-text" type="button" id="import-location-select">
                                    Model Location:
                                </button>
                                <input type="text" style="font-size: 0.85rem" class="form-control" id="import-location" aria-describedby="import-location-select" placeholder="Location of the custom model files"  required>
                            </div>
                        </div>
                        <div class="pb-3">
                            <div class="input-group">
                                <span class="input-group-text" id="model-name-text">
                                    Model Name:
                                </span>
                                <input type="text" class="form-control" id="model-name" aria-describedby="model-name-text" placeholder="Choose a unique name for the model" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id="import" type="submit" class="btn btn-success">Import</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Model remove modal -->
    <div class="modal fade" id="expunge-modal" tabindex="-1" aria-labelledby="expunge-modal-label" aria-modal="true">
        <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expunge-modal-label">Remove Custom Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="expunge-form">
                    <div id="expunge-modal-body" class="modal-body">
                        <div class="pb-3">
                            <div class="input-group">
                                <span class="input-group-text" id="expunge-model">
                                    Model:
                                </span>
                                <select class="form-select mb-0" id="custom-models" required></select>
                            </div>
                        </div>
                        <div class="alert alert-danger" role="alert" id="expunge-warning">
                            N.B. This will remove the model and its associated species and records from the database.
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id="expunge" type="submit" class="btn btn-success">Remove Model</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-modal="true">
        <div class="modal-dialog  modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="helpModalLabel">Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="helpModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="help-modal-close">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Species Modal -->
    <div class="modal fade" id="speciesModal" tabindex="-1" aria-labelledby="speciesModalLabel" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered ">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="speciesModalLabel">Current Species List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="speciesModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-evenly">
                    <button id="export-list" type="button" class="btn btn-light">Export the Included List</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Analyse selection modal -->
    <div class="modal fade" id="detectionsModal" tabindex="-1" aria-labelledby="detectionsModalLabel" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center text-bg-dark">
                    <h5 class="modal-title" id="detectionsModalLabel">Audio Selection Analysis</h5>
                </div>
                <div id="detectionsModalBody" class="modal-body p-0 ">
                    <table id="selectionResults" class="text-center table w-100 align-middle">
                        <thead id="selectionResultsHead">
                            <tr class="text-bg-dark">
                                <th class="text-start timeOfDay">Time</th>
                                <th class="text-start timestamp">Position</th>
                                <th class="text-start">Species</th>
                                <th class="text-start">Model</th>
                            </tr>
                        </thead>
                        <tbody class="text-dark" id="selectionResultTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Goto Modal -->
    <div class="modal fade" id="gotoModal" tabindex="-1" aria-labelledby="gotoModalLabel" aria-modal="true">
        <form id="gotoForm">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="gotoModalLabel">Go to Position</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                        
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="datetime-local" step="1" class="form-control" id="timeInput" name="timeInput">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="go">Go</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
        <!-- Location Modal -->
        <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel"
        aria-modal="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Set Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pb-0">
                    <form id="locationForm" class="fs-6">
                        <fieldset class="border rounded m-2 p-1">
                            <legend class="h6">Pick A Saved Location</legend>
                            <div class="form-group rounded p-2 bg-light">
                                <div class="row">
                                    <div class="input-group col">
                                        <div class="form-group w-100">
                                            <select class="form-select" id="savedLocations">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="border rounded m-2 mb-0 p-1" id="edit-section">
                            <legend class="h6">Add, Edit or Delete Location</legend>
                            <div class="form-group rounded p-2 bg-light">
                                <div class="row">
                                    <div class="input-group col">
                                        <label id="customLatLabel" class="input-group-text pe-2" for="customLat">Lat:</label>
                                        <input id="customLat" type="number" class="form-control ps-2"
                                        placeholder="0.00" step="0.001" max="90" min="-90" aria-label="Latitude" aria-describedby="customLat"
                                        required>
                                        <label id="customLonLabel" class="input-group-text pe-2" for="customLon">Lon:</label>
                                        <input id="customLon" type="number" class="form-control ps-2"
                                        placeholder="0.00" step="0.0001" max="180" min="-180"  aria-label="Longitude" aria-describedby="customLon"
                                        required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-10">
                                        <div class="d-flex align-items-center mt-2 mb-0">
                                            <legend class="h6 mt-2 mb-0">Location radius</legend>
                                            <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                                <span class="pointer locked material-symbols-outlined">lock</span>
                                            </a>
                                        </div>
                                        <input id="location-radius" class="input-group locked disabled" style="width:100%" type="range" value="30" min="10" max="2500" step="10"/>
                                    </div>
                                    <div class="col-2 input-group-append d-flex align-items-end ps-0">
                                        <span class="input-group-text" id="radius-value"><b>30m</b></span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                            <div class="form-group rounded p-2 bg-light mt-2">
                                <div id="customLocationMap" class="mt-2 border border-secondary rounded" style="height: 200px"></div>
                            </div>
                        <fieldset class="border rounded m-2 mt-0 p-1">
                                <div class="row">
                                    <div class="input-group p-1">
                                        <textarea class="m-2 w-100" id="customPlace" spellcheck="false" maxlength="100" required></textarea>
                                    </div>
                                </div>
                                <div class="row d-none" id="location-batch-wrapper">
                                    <div class="input-group col mt-2">
                                        <input class="form-check-input" type="checkbox" value="" id="batchLocations">
                                        <label class="form-check-label ps-2" for="batchLocations">
                                            Update ALL open files to this location
                                        </label> 
                                    </div>
                                </div>
                            
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto d-none" id="delete-location">Delete Location</button>
                    <button type="button" class="btn btn-primary" id="set-location">Set Location</button>
                </div>
            </div>
        </div>
    </div>
    <!-- context menu-->
    <div class="dropdown-menu dropdown-menu-sm" id="context-menu"> </div>
            <!-- End context menu -->
    <!-- Records container -->
    <div class="d-none h-100 overflow-auto" id="recordsContainer">
        <div class="container-fluid">
            <div class="row p-1 g-1 justify-content-evenly">
                <div class="col-3 pt-4" style="max-width: 25rem;" >
                    <div class="col pt-2">
                        <div class="btn btn-light pt-3 mb-2" id="chartRange">
                            <span class="material-symbols-outlined align-bottom">date_range</span>&nbsp;
                            <span id="chart-datefilter">Apply a date filter</span> <span
                            class="material-symbols-outlined  align-bottom">expand_more</span>
                        </div>
                    </div>
                    <div class="mb-2 col"> 
                        <!-- <input type="text" class="form-control mb-3" id="bird-search"> -->
                        <div class="form-floating bird-search">
                            <!-- Bootstrap-styled input -->
                            <input type="text" class="form-control autocomplete" id="bird-autocomplete-chart" placeholder="Type to search...">
                            <!-- Caret rendered inside the input -->
                            <span class="input-caret"></span>
                            <!-- Suggestion list styled as a Bootstrap list group -->
                            <label class="species-search-label" for="bird-autocomplete-chart">Species Search</label>
                            <ul id="bird-suggestions-chart" class="suggestions list-group"></ul>
                        </div>
                    </div>
                    <div class="col">
                        <div id="chart-location-list" class="form-floating">
                            <select spellcheck="false" class="input form-select mb-3 locked" aria-label=".form-select"
                            id="chart-locations"></select>
                            <label for="chart-locations">Location <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a></label>
                        </div>
                    </div>
                    <div class="col">
                        <fieldset class="border border rounded bg-light p-2">
                            <legend class="h6" id="GroupBy">Group detections by:</legend>
                            <div class="form-row">
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="showTotals" id="hour" value="hour">
                                    <label class="form-check-label" for="hour">Hour</label>
                                </div>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="showTotals" id="day" value="day">
                                    <label class="form-check-label" for="day">Day</label>
                                </div>
                                <div class="form-check-inline pb-3">
                                    <input class="form-check-input" type="radio" name="showTotals" id="week" value="week" checked>
                                    <label class="form-check-label" for="week">Week</label>
                                </div>
                            </div>
                            <div class="form-row pt-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" name="stackYears" id="stackYears">
                                    <label class="form-check-label" for="stackYears">Split results by year</label>
                                </div>
                            </div>
                            <div class="form-row pt-3">
                                <button id="downloadChart" class="btn btn-primary w-100">Export Chart Image</button>
                            </div>
                        </fieldset>
                    </div>
                </div>                            
                <div class="col-9">
                    <div class="chart-outer position-relative" id="chart-outer">
                        <span class="material-symbols-outlined text-muted" style="z-index: 2;position: absolute; top: 40px; left: 30px" title="View Fullscreen" onclick="goFullscreen()">fullscreen</span>
                        <canvas class="border border-dark rounded-3 w-100" id="chart-week"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-3"></div>
                <div id="dataRecords" class="col-9 ps-5">
                    <table class="table table-striped border border-dark rounded-border">
                        <tbody id="recordsTableBody">
                            <tr>
                                <th id="speciesName" class="text-center" colspan="6"></th>
                            </tr>
                            <tr>
                                <th id="ESR">Earliest Spring Record</th>
                                <th id="LSR">Latest Spring Record</th>
                                <th id="EAR">Earliest Autumn Record</th>
                                <th id="LAR">Latest Autumn Record</th>
                                <th id="MC">Most Calls in 24 hours</th>
                            </tr>
                            <tr>
                                <td id="earliestSpring"></td>
                                <td id="latestSpring"></td>
                                <td id="earliestAutumn"></td>
                                <td id="latestAutumn"></td>
                                <td id="mostDetections"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Loading Spinner Overlay -->
    <div id="loading" class="overlay d-none text-white">
        <div id="loadingText" class="d-flex"></div>
        <div class="d-flex justify-content-evenly">
            <div class="spinner-grow spinner-grow-sm m-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="spinner-grow spinner-grow-sm m-3" role="status" style="animation-delay: 0.5s;">
            </div>
            <div class="spinner-grow spinner-grow-sm m-3" role="status" style="animation-delay: 1s;">
            </div>
          </div>
    </div>
        <!-- DIV to Hold the spec frequency controls -->
        <div class="range_container d-none" id="frequency-range-panel">
            <fieldset class="border border-secondary rounded m-2 p-2">
                <legend class="pb-2 text-bg-dark h6" id="frequency-range-legend">Spectrogram Frequency Range</legend>
                <div class="sliders_control">
                    <input id="fromSlider" type="range" value="0" min="0" max="11950" step="50"/>
                    <input id="toSlider" type="range" value="12000" min="0" max="11950" step="50"/>
                </div>
                <div class="form_control">
                    <div class="form_control_container">
                        <div class="form_control_container__time">Min Hz</div>
                        <input class="rounded" type="number" id="fromInput" value="0" min="0" max="11950" step="50"/>
                    </div>
                    <div class="form_control_container">
                        <div class="form_control_container__time">Max Hz</div>
                        <input class="rounded" type="number" id="toInput" value="11950" min="0" max="11950" step="50"/>
                    </div>
                    <div class="form_control_container d-flex">
                        <div class="form_control_container__time"></div>
                        <button class="btn btn-secondary disabled align-self-end pt-0 pb-0" id="reset-spec-frequency" onclick="return false">Reset</button>
                    </div>
                </div>
            </fieldset>
        </div>
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="settings" aria-labelledby="offcanvas">
        <div class="offcanvas-header pb-2">
            <h5 class="offcanvas-title" id="offcanvas">Settings</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" id="close-settings" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body pt-0">
            <div class="btn-group w-100 p-2 mt-0 position-sticky top-0 bg-dark" style="z-index: 2000;" role="group" aria-label="Settings mode">
                <button type="button" id="basic" class="btn btn-primary w-50">Basic</button>
                <button type="button" id="advanced" class="btn btn-secondary w-50">Advanced</button>
            </div>  
            <!-- Offcanvas -->
            <form id="settingsForm" class="fs-6 form-floating">
                <fieldset class="border border-secondary rounded m-2 mt-0 mb-0 p-2">
                    
                    <legend style="font-size: large;font-weight:bold">Detections</legend>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Model" id="Model-circle-help"  data-bs-content="Select whether to use the Nocmig model, optimised for Nocturnal Migration Calls in Europe, or BirdNET, which can detect over 6000 species across the globe.">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="ps-1 input-group-text col-5" for="model-to-use">Model:</label>
                            <select class="form-select mb-0" id="model-to-use">
                                <option value="birdnet">BirdNET</option>
                                <option value="chirpity">Nocmig</option>
                                <option value="nocmig">Nocmig v2 (beta)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="form-check form-switch">
                            <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a>
                            <input class="locked form-check-input" type="checkbox" role="switch" id="combine-detections" disabled>
                            <label class="form-check-label" for="combine-detections">Combine model detections</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-html="true" data-bs-title="Combine model detections" id="Combine-circle-help"  data-bs-content="When enabled, repeating the analysis of open files with a different model will add the model's detections to the list. Note: during the new analysis, only the results of the current model will be shown">?</a>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="form-check form-switch">
                            <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a>
                            <input class="locked form-check-input" type="checkbox" role="switch" id="merge-detections" disabled>
                            <label class="form-check-label" for="merge-detections">Merge model detections</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-html="true" data-bs-title="Merge model detections" id="Merge-circle-help"  data-bs-content="When enabled, detections for each model will be merged, only the detection with the highest confidence from the models will be displayed. Note: during the new analysis, only the results of the current model will be shown">?</a>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Confidence Threshold" id="Confidence Threshold-circle-help"  data-bs-content="Determines the minimum confidence required for results to be returned">?</a>
                        <label for="confidence">Confidence threshold:</label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" id="confidence" min="5" max="100" step="5">
                            <div class="input-group-append">
                                <span class="input-group-text" id="confidence-value">50%</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Detections Per Segment" id="Detections Per Segment-circle-help"  data-bs-content="Select the maximum number of detections that will be shown in any 3 second period">?</a>
                        <label for="top-rankin">Detections per segment:</label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" id="top-rankin" min="1" max="4" step="1">
                            <div class="input-group-append">
                                <span class="input-group-text" id="top-rankin-value">1</span>
                            </div>
                        </div>
                    </div>
                    <div class="advanced">
                        
                        <div class="chirpity-only">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Context Mode" id="Context Mode-circle-help"  data-bs-content="When enabled, context mode adapts predictions by analysing the surrounding context.
                                    It can only be changed prior to an analysis, and a low initial confidence threshold is recommended e.g 20-30%. Context mode is not available in the BirdNET model">?</a>
                            <div class="form-group rounded p-2 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="context">
                                    <label class="form-check-label" for="context">
                                        Context mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="List" id="List-circle-help"  data-bs-content="Filters the detections returned in results. Local Birds: excludes birds 
                        unlikely to be found in your region. Nocturnal Calls: excludes bird song and species not known to call at night. The custom list allows you to upload a file listing the species to detect">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="ps-1 input-group-text col-5" for="list-to-use">List:</label>
                            <select class="form-select mb-0" id="list-to-use">
                                <option value="location">Local Birds</option>
                                <option value="nocturnal">Nocturnal Calls</option>
                                <option value="birds">Birds</option>
                                <option value="everything">Everything</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="list-hidden" id="choose-file-container">
                            <div class="col-auto input-group rounded p-2 pe-3">
                                <button class="btn btn-outline-secondary" type="button" id="list-file-selector"> Select file</button>
                                <input type="text" class="form-control" id="custom-list-location" aria-describedby="list-file-selector" placeholder="No custom list set" disabled="" readonly="">
                                <span id="clear-custom-list" class="material-symbols-outlined btn btn-outline-secondary p-1" title="Clear custom list">clear</span>
                            </div>
                        </div>
                        <div class="list-hidden pb-2" id="use-location-container">
                            <div class="form-switch ms-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="local">
                                <label class="form-check-label" for="local">Use Location settings</label>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Use Location settings" id="Use Location settings-circle-help"  data-bs-content="When activated, the Nocturnal birds filter reports birds based on your location settings.">?</a>
                            </div>
                        </div>
                        <div class="advanced list-hidden" id="species-threshold-el">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Species Threshold" id="Species Threshold-circle-help"  data-bs-content="Define the minimum eBird checklist frequency for species inclusion.
                            If 'Adjust list for the week of the year' is enabled, the list will be adjusted to include species expected for the recording week.">?</a>
                            <div class="pe-3 input-group rounded p-2 mb-1">
                                <label class="input-group-text bg-dark text-warning" for="species-frequency-threshold">Species Threshold:</label>
                                <input id="species-frequency-threshold" type="number" class="form-control" style="width: 30%;" value="0.03" step="0.01" min="0.01" max="1" aria-label="species frequency threshold" aria-describedby="species-frequency-threshold">
                            </div>
                            <div class="text-nowrap mt-2"><label class="ms-2 me-2" for="species-week">Adjust list for the week of the year</label>
                                <span class="form-switch ms-2">
                                    <input id="species-week" role="switch" type="checkbox" class="form-check-input form-check-inline">
                                </span>
                            </div>                                                                
                        </div>
                    </div>
                    
                    <div class="form-group rounded p-2">
                        <div class="form-check form-switch ps-0">
                            <button class="btn btn-primary" id="show-species" onclick="return false">Show the species included</button>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="nocmig">
                            <label class="form-check-label" for="nocmig">Only analyse night time periods.</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Nocmig Mode" id="Nocmig Mode-circle-help"  data-bs-content="When enabled, this 'Nocmig mode' only searches for and only displays detections found during the night">?</a>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="form-check form-switch">
                            <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a>
                            <input class="locked form-check-input" type="checkbox" role="switch" id="auto-load" disabled>
                            <label class="form-check-label" for="auto-load">Auto-load saved detections</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Auto-load detections" id="Auto-load-circle-help"  data-bs-content="When enabled, saved detections are displayed immediately upon opening a file.">?</a>
                        </div>
                    </div>
                    <div class="advanced">
                        <hr>
                        <div class="form-group rounded p-2 pe-0 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="iucn">
                                <label class="form-check-label" for="iucn">Show species IUCN Red List status in summary.</label>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Red List Status" id="IUCN-circle-help"  
                                    data-bs-content="When enabled, the latest Global IUCN assessment status is displayed for each species in the summary. The icon links to the assessment page on the IUCN website. The Assessment Scope will display the IUCN assessment of the species in that region (where available).">?</a>
                            </div>
                        </div>
                    
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label for="iucn-scope" class="input-group-text bg-dark text-warning">Assessment Scope:</label>
                            <select class="form-select mb-0" id="iucn-scope">
                                <option value="Global">Global</option>
                                <option value="Europe">Europe</option>
                                <option value="Mediterranean">Mediterranean</option>
                            </select>
                        </div>

                        <hr>
                        <div class="form-group rounded text-center">
                            <div class="form-check form-switch ps-2">
                                <button class="btn btn-primary" id="clear-call-cache" onclick="return false">Clear Reference Call Cache</button>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Clear Call Cache" id="Clear Call Cache-circle-help"  data-bs-content="The data used for the reference call comparisons are cached. Clearing the cache will refresh the calls for each species the next time a comparison is requested">?</a>
                            </div>
                        </div>
                    </div>
                    
                    <fieldset class="advanced border border-secondary rounded m-2 mb-0 p-2 "> 
                        <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content=""><span class="pointer locked material-symbols-outlined">lock</span></a>
                        <span class="d-inline-flex float-end"><a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Keyboard assignment" id="Assign Keyboard-circle-help"  data-bs-content="Use number keys for rapid result tagging. Assign a species, label or predefined comment to a result">?</a></span>
                        <legend style="font-size: small; font-weight:bold">
                            Keyboard Assignment
                        </legend>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">1</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key1-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key1">
                            <div id="bird-list-key1" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">2</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key2-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key2">
                            <div id="bird-list-key2" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">3</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key3-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key3">
                            <div id="bird-list-key3" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">4</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key4-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key4">
                            <div id="bird-list-key4" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">5</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key5-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key5">
                            <div id="bird-list-key5" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">6</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key6-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key6">
                            <div id="bird-list-key6" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">7</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key7-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key7">
                            <div id="bird-list-key7" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">8</kbd> 
                            <select class="locked form-select w-50 ms-2"  style="font-size: small" id="key8-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key8">
                            <div id="bird-list-key8" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">9</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key9-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key9">
                            <div id="bird-list-key9" class="suggestions list-group"></div>
                        </div>
                        <div class="d-flex align-items-center mb-2 position-relative">
                            <kbd class="text-bg-light ps-2 pe-2">0</kbd> 
                            <select class="locked form-select w-50 ms-2" style="font-size: small" id="key0-column">
                                <option value="">Unused</option>
                                <option value="species">Species</option>
                                <option value="label">Label</option>
                                <option value="comment">Comment</option>
                            </select>
                            <input type="text" disabled class="ms-2 form-control" style="font-size: small" id="key0">
                            <div id="bird-list-key0" class="suggestions list-group"></div>
                        </div>
                    </fieldset>    
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Default Location <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Default Location" id="Default Location-circle-help"  data-bs-content="Chirpity uses location information to determine the dawn and dusk times for recordings">?</a></legend>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="input-group">
                            <label class="input-group-text pe-2" for="latitude">Lat:</label>
                            <input id="latitude" type="number" class="form-control ps-2 " placeholder="0.00" step="0.0001" max="90" min="-90" aria-label="Latitude" aria-describedby="latitude">
                            <label class="input-group-text pe-2" for="longitude">Lon:</label>
                            <input id="longitude" type="number" class="form-control ps-2" placeholder="0.00" step="0.0001"  max="180" min="-180" aria-label="Longitude" aria-describedby="longitude">
                        </div>
                        <div class="mt-1 float-end">
                            <button class="btn btn-primary" id="apply-location" onclick="return false">Set</button>
                            <button class="btn btn-secondary" id="cancel-location" onclick="return false">Cancel</button>
                        </div>
                        <div class="clearfix"></div>
                        <div id="settingsMap" class="mt-2 border border-secondary rounded"></div>
                        <div class="mt-2" id="place"></div>
                    </div>
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">System</legend>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Language" id="Language-circle-help"  data-bs-content="Select your preferred language for birds' common names">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="ps-1 input-group-text col-5" for="locale">Language:</label>
                            <select class="form-select mb-0" id="locale">
                                <option value="en_uk">English (UK) *</option>
                                <option value="en">English (US)</option>
                                <option value="af">Afrikaans</option>
                                <option value="ar"></option>
                                <option value="cs">etina</option>
                                <option value="ca">Catal</option>
                                <option value="da">Dansk *</option>
                                <option value="de">Deutsch *</option>
                                <option value="es">Espaol *</option>
                                <option value="fi">Suomi</option>
                                <option value="fr">Franais *</option>
                                <option value="hu">Magyar</option>
                                <option value="it">Italiano</option>
                                <option value="ja"> *</option>
                                <option value="ko"></option>
                                <option value="nl">Nederlands *</option>
                                <option value="no">Norsk</option>
                                <option value="pl">Polski</option>
                                <option value="pt_PT">Portugus (PT)*</option>
                                <option value="pt_BR">Portugus (BR)</option>
                                <option value="ro">Romn</option>
                                <option value="ru"> *</option>
                                <option value="sk">Slovenina</option>
                                <option value="sl">Slovenina</option>
                                <option value="sv">Svenska *</option>
                                <option value="th"></option>
                                <option value="tr">Trke</option>
                                <option value="uk"></option>
                                <option value="zh"> *</option>
                                <!-- <option value="custom">Custom</option> -->
                            </select>
                        </div>
                    </div>
                    <div class="">
                        <div class="p-0 node-only d-none">
                            <div class="form-group rounded p-2 pe-0 mb-2">
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Backend" id="Backend-circle-help"  data-bs-content="The GPU backend can improve performance and reduce power consumption on some systems.">?</a>
                                <div>
                                    <label class="ps-0 fs-6 text-start form-check" for="backend">Backend: <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a></label>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="tensorflow">CPU</label>
                                        <input class="form-check-input" type="radio" name="backend" id="tensorflow" value="tensorflow" checked="">
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input locked" type="radio" name="backend" id="webgpu" value="webgpu" disabled>
                                        <label class="form-check-label" for="webgpu">GPU</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="advanced">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Threads" id="Threads-circle-help"  data-bs-content="The number of parallel analyses to run. By default, 
                            this is set to the number of CPU cores on the machine for fastest performance. With the GPU backend, a lower number works better e.g. 1-3">?</a>
                            <div class="form-group rounded p-2 pe-0 mb-2">
                                <label for="thread-slider">Threads:</label>
                                <div class="input-group">
                                    <input type="range" class="form-control-range w-75" id="thread-slider" min="1" max="24">
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="threads-value">12</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="advanced">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Batch Size" id="Batch Size-circle-help"  data-bs-content="Optimising the batch size can increase processing speed on longer files.">?</a>
                            <div class="form-group rounded p-2 pe-0 mb-2">
                                <label for="batch-size">Batch Size:</label>
                                <div class="input-group">
                                    <input type="range" class="form-control-range w-75" id="batch-size" min="1" max="256">
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="batch-size-value"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Audio notification" id="Audio notification-circle-help"  data-bs-content="When enabled, there will be a system notification when analyses that take over thirty seconds are finished.">?</a>
                            <div class="pe-3 form-group rounded p-2 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="audio-notification">
                                    <label class="form-check-label" for="audio-notification">Enable analysis completion notifications</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="File timestamp marks recording start" id="File-timestamp-circle-help"  data-bs-content="Some audio recorders, for example the Zoom H1 Essential, can set the file saved date and time to the beginning of the recording, rather than the end. 
                                    If you have such a recorder selecting this option will fix the times shown for your detections.">?</a>
                        
                            <div class="form-group rounded p-2 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="file-timestamp">
                                    <label class="form-check-label" for="file-timestamp">
                                        File timestamps mark recording start
                                    </label>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="input-group rounded p-2" id="choose-database-location">
                            <div class="col-auto pe-1">
                                <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                <span class="pointer locked material-symbols-outlined">lock</span></a>
                            </div>
                            <div class="col">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary text-warning locked disabled" type="button" id="database-location-select">
                                        Database Location:</button>
                                    <input type="text" class="form-control" id="database-location" aria-describedby="database-location-select" placeholder="Default" readonly>
                                    <span id="clear-database-location" class="material-symbols-outlined btn btn-outline-secondary p-1" title="Clear custom database location">clear</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Adjust font size" id="Adjust font size-circle-help"  data-bs-content="Change the global font size settings for the application.">?</a>
                        <div class="pe-3 form-group rounded p-2 mb-2">
                            <label for="font" class="form-label">Adjust font size: </label>
                            <span  id="decreaseFont" class="material-symbols-outlined btn btn-outline-secondary p-1">text_decrease</span> 
                            <span  id="increaseFont" class="material-symbols-outlined btn btn-outline-secondary p-1">text_increase</span>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Audio Preferences</legend>
                    <div class="me-auto">
                        <div class="advanced form-group rounded p-2 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="send-filtered-audio-to-model">
                                <label class="form-check-label" for="send-filtered-audio-to-model">
                                    Send Filtered Audio for Analysis
                                </label>
                                <a class="circle text-bg-danger" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Send Filtered Audio" id="Send Filtered Audio-circle-help"  data-bs-content="Sending High Pass or Low Shelf filtered audio to a model will usually have a negative impact on its accuracy. Use this option with caution!">?</a>
                            </div>
                        </div>
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Volume Adjustment" id="Volume Adjustment-circle-help"  data-bs-content="Adjust the volume of audio to compensate for low recording levels.">?</a>
                            <label for="gain" class="form-label">Volume Adjustment:</label>
                            <div class="input-group me-0 p-0">
                                <input type="range" class="form-control-range w-75" min="0" max="50" id="gain">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="gain-adjustment">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="col form-check form-switch">
                            <label class="form-check-label" for="normalise">Normalise Audio:</label>
                            <input class="form-check-input" type="checkbox" role="switch" id="normalise">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Normalise" id="Normalise-circle-help"  data-bs-content="When enabled, the audio you hear will be normalised, expanding the dynamic range.">?</a>
                        </div>
                    </div>
                    <hr>
                    <div class="me-auto">
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="High Pass Filter" id="High Pass Filter-circle-help"  data-bs-content="When set, removes low frequency noise below the threshold.">?</a>
                            <label for="highPassFrequency" class="form-label">
                                High Pass filter:
                            </label>
                            <div class="input-group me-0 p-0">
                                <input type="range" class="form-control-range w-75" min="0" max="15000" step="25" id="highPassFrequency">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="HP-threshold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="me-auto">
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Low Pass Filter" id="Low Pass Filter-circle-help"  data-bs-content="When set, removes high frequency noise above the threshold.">?</a>
                            <label for="lowPassFrequency" class="form-label">
                                Low Pass filter:
                            </label>
                            <div class="input-group me-0 p-0">
                                <input type="range" class="form-control-range w-75" min="0" max="15000" step="25" id="lowPassFrequency">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="LP-threshold">15000Hz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6>Low Shelf filter</h6>
                    <div class="form-group rounded p-2 me-0 mb-2">
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Low Shelf Filter" id="Low Shelf Filter-circle-help"  data-bs-content="When used, attenuates low frequency noise below the cut-off frequency.">?</a>
                        <label for="lowShelfFrequency" class="form-label">Cut-off Frequency:</label>
                        <div class="input-group me-0 p-0">
                            <input type="range" class="form-control-range w-75" min="0" max="2500" step="100" id="lowShelfFrequency">
                            <div class="input-group-append">
                                <span class="input-group-text" id="LowShelf-threshold">0</span>
                            </div>
                        </div>
                        <label for="attenuation" class="form-label">Attenuation:</label>
                        <div class="input-group me-0 p-0">
                            <input type="range" class="form-control-range w-75" min="0" max="50" id="attenuation">
                            <div class="input-group-append">
                                <span class="input-group-text" id="attenuation-threshold">0 dB</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="fs-6">Audio Export:</h6>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="format" class="ps-1 input-group-text col-5">Format:</label>
                        <select class="form-select mb-0" id="format">
                            <option value="wav">WAV</option>
                            <option value="flac">FLAC</option>
                            <option value="mp3">MP3</option>
                            <option value="aac">AAC</option>
                            <option value="opus">Opus</option>
                        </select>
                    </div>
                    <div id="bitrate-container" class="pe-3 input-group rounded p-2 mb-1">
                        <label for="bitrate" class="ps-1 input-group-text col-5">Bitrate:</label>
                        <select class="form-select mb-0" id="bitrate">
                            <option value="320">320 kbps</option>
                            <option value="192">192 kbps</option>
                            <option value="160">160 kbps</option>
                            <option value="128">128 kbps (recommended)</option>
                            <option value="96">96 kbps</option>
                            <option value="64">64 kbps</option>
                        </select>
                    </div>
                    <div id="quality-container" class="pe-3 input-group rounded p-2 mb-1">
                        <label for="quality" class="input-group-text  col-6">Compression:</label>
                        <select class="form-select mb-0" id="quality">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="pe-2 form-group rounded p-2 mb-2">
                        <div class="form-check-inline w-75 form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="downmix">
                            <label class="form-check-label" for="downmix">Convert to mono</label>
                        </div>
                        <a class="ms-auto circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Down mix" id="Down mix-circle-help"  data-bs-content="When enabled, exported audio will be downmixed to mono">?</a>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="row pe-2">
                            <label class="col-3" for="decorators">Decorators: </label>
                            <div class="col-6 ">
                                <div class="form-check-inline text-nowrap">
                                    <input class="form-check-input" type="checkbox" id="padding" value="2" checked="">
                                    <label class="form-check-label" for="padding">
                                        Pad
                                    </label>
                                    <input class="form-check-input" type="checkbox" id="fade" disabled="" value="1">
                                    <label class="form-check-label" for="fade">
                                        Fade
                                    </label>
                                </div>
                            </div>
                            <div class="col-3">
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Decorators" id="Decorators-circle-help"  data-bs-content="'Pad' adds 2 seconds before and after a selection to the exported audio.
                                'Fade' adds a 1 second fade effect to the start and end of the audio">?</a>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <a class="circle new-circle me-2" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Audio Library" id="Audio Library-circle-help"  
                        data-bs-html="true" data-bs-sanitize="false" data-bs-content="Chirpity can organise your audio into a permanent library at a location of your choice, such as a data disk or network drive. Once saved, you can remove the original files, and all records will be viewable in the application.

                        To save audio to the library, you can either go to the Records menu and choose 'Save Audio from Archive Results to Library', or enable the 'Add to Library on Save' option below.
                        
                        Files will be stored in the following structure:
                        
                        <p><code>Recording Site / Year / Month / Filename</code></p>
                        'Lossy' audio requires about 1GB of storage per 24 hours, while 'Lossless' converts files to FLAC format, preserving original fidelity, bitrate, and channels, but roughly halving the file size.">?</a>
                        <h6 class="fs-6">Audio Library</h6>
                        
                        <div class="input-group rounded p-2" id="choose-library-location">
                            <div class="col">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" id="library-location-select">Library Location:</button>
                                    <input type="text" class="form-control" id="library-location" aria-describedby="library-location-select" placeholder="No location set" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group rounded p-2 mb-2">
                            <div class="col form-check form-switch">
                                <label class="form-check-label" for="auto-library">Add to Library on Save</label>
                                <input class="form-check-input" type="checkbox" role="switch" id="auto-library" disabled>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Add to Library on Save" id="Add to Library on Save-circle-help"  data-bs-content="When enabled, audio files are added to the library location whenever detections are saved to the archive.">?</a>
                            </div>
                        </div>
                        <div class="form-group rounded p-2 mb-2">
                            <div class="col form-check form-switch">
                                <label class="form-check-label" for="library-trim">Crop Library audio to night time periods</label>
                                <input class="form-check-input" type="checkbox" role="switch" id="library-trim" disabled>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Crop Library" id="Crop Library-circle-help"  data-bs-content="When enabled, audio files containing daylight periods are cropped, so the audio is only saved for nocturnal periods.">?</a>
                            </div>
                        </div>
                        <div class="form-group rounded p-2 mb-2">
                            <div class="col form-check form-switch">
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Only save files with records" id="Clip Library-circle-help"  data-bs-content="When enabled, only audio files containing saved records are added to the library. 
                                If you set your recorder to auto-increment files after a short period of time, enabling this setting will dramatically reduce the storage required if there are long periods without activity">?</a>
                                <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                        <span class="pointer locked material-symbols-outlined">lock</span></a>
                                <input class="locked form-check-input" type="checkbox" role="switch" id="library-clips" disabled>
                                <label class="form-check-label" for="library-clips">Only save files with records</label>
                            </div>
                        </div>
                        <div class="input-group rounded p-2 mb-1">
                            <label for="library-format" class="ps-1 input-group-text col-5">Library Format:</label>
                            <select class="form-select mb-0" id="library-format">
                                <option value="ogg">Lossy (recommended)</option>
                                <option value="flac">Lossless</option>
                            </select>
                            
                        </div>
                    
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Spectrogram Preferences</legend>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="col form-check form-switch">
                            <label class="form-check-label" for="spec-labels">Display frequency labels:</label>
                            <input class="form-check-input" type="checkbox" role="switch" id="spec-labels">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Show frequency labels" id="Show frequency labels-circle-help"  data-bs-content="When enabled, the spectrogram will display the frequency on the left side.">?</a>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="col form-check form-switch">
                            <a tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Feature Locked" class="padlock" data-bs-sanitize="false" data-bs-html="true" data-bs-content=""><span class="pointer locked material-symbols-outlined">lock</span></a>
                            <input class="locked form-check-input" type="checkbox" role="switch" id="spec-detections" disabled>
                            <label class="form-check-label" for="spec-detections">Show all detections</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Show all detections" id="Show all detections-circle-help"  data-bs-content="When enabled, the spectrogram will highlight all the detections on screen.">?</a>
                        </div>
                    </div>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="colourmap" class="ps-1 input-group-text col-5">Colourmap:</label>
                        <select class="form-select mb-0" id="colourmap">
                            <option value="custom">Custom</option>
                            <option value="igray">Greyscale</option>
                            <option value="gray">Inverted Greyscale</option>
                            <option value="bone">Bone</option>
                            <option value="turbidity">Turbidity</option>
                            <option value="chlorophyll">Chlorophyll</option>
                            <option value="viridis">Viridis</option>
                            <option value="cdom">CDom</option>
                            <option value="temperature">Temperature</option>
                            <option value="salinity">Salinity</option>
                            <option value="roseus">Roseus</option>
                            <option value="inferno">Inferno</option>
                            <option value="magma">Magma</option>
                            <option value="plasma">Plasma</option>
                            <option value="hot">Hot</option>
                            <option value="blackbody">Blackbody</option>
                        </select>
                    </div>
                    <fieldset class="border border-secondary rounded m-2 p-2 d-none" id="colormap-fieldset">
                        <div class="mt-2">
                            <input class="form-input pointer" type="color" id="loud-color" value="#cc00ff">
                            <label class="form-label pointer" for="loud-color">Peak colour</label><br>
                            <input class="form-input pointer" type="color" id="mid-color" value="#000000">
                            <label class="form-label pointer" for="mid-color">Mid colour</label><br>
                            <input class="form-input pointer" type="color" id="quiet-color" value="#000000">
                            <label class="form-label pointer" for="quiet-color">Quiet colour</label>
                        </div>
                        <label for="quiet-color-threshold-slider" class="form-label">
                            Quiet Cut-off:
                        </label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" min="0" max="1" step="0.01" id="quiet-color-threshold-slider">
                            <div class="input-group-append">
                                <span class="input-group-text" id="quiet-color-threshold">0.0</span>
                            </div>
                        </div>
                        <label for="mid-color-threshold-slider" class="form-label">
                            Mid Position:
                        </label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" min="0" max="1" step="0.01" id="mid-color-threshold-slider">
                            <div class="input-group-append">
                                <span class="input-group-text" id="mid-color-threshold">0.5</span>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="border border-secondary rounded m-2 p-2" id="window-fieldset">
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label for="window-function" class="ps-1 input-group-text col-5">Window function:</label>
                            <select class="form-select mb-0" id="window-function">
                                <option value="bartlett">Bartlett</option>
                                <option value="bartlettHann">BartlettHann</option>
                                <option value="blackman">Blackman</option>
                                <option value="cosine">Cosine</option>
                                <option value="gauss">Gauss</option>
                                <option value="hamming">Hamming</option>
                                <option value="hann">Hann</option>
                                <option value="lanczoz">Lanczoz</option>
                                <option value="rectangular">Rectangular</option>
                                <option value="triangular">Triangular</option>
                            </select>
                        </div>
                        <div id="alpha" class="pe-3 input-group rounded p-2 mb-1 d-none">
                            <label for="alpha-slider" class="form-label">
                                Gauss Alpha:
                            </label>
                            <div class="input-group">
                                <input type="range" class="form-control-range w-75" min="0.01" max="1.0" step="0.01" id="alpha-slider">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="alpha-value">0.5</span>
                                </div>
                            </div>
                        </div>
                    
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label for="timelineSetting" class="ps-1 input-group-text col-5">Timeline:</label>
                            <select class="form-select mb-0" id="timelineSetting">
                                <option value="timecode">Timecode</option>
                                <option value="timeOfDay">Time of day</option>
                            </select>
                        </div>
                    </fieldset>
                </fieldset>
                <fieldset class="advanced border border-secondary rounded m-2 p-2">
                    <legend class="pb-2" style="font-size: large;font-weight:bold;color: white">Advanced</legend>
                    <div class=" col-auto form-group rounded p-2 mb-2">
                        <div class="text-nowrap">   
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="debug-mode">
                                <label class="form-check-label me-2" for="debug-mode">Debug mode</label><a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Debug Mode" id="Debug Mode-circle-help"  data-bs-content="Enter debug mode (changes to this setting require a Chirpity relaunch to take effect)">?</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto form-group rounded p-2 mb-2">
                        <div class="text-nowrap">
                            <button class="btn btn-warning" id="reset-defaults" onclick="return false">Reset to default settings</button>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Default Settings" id="Default Settings-circle-help"  data-bs-content="Reset the configuration settings to their default values. N.B. Relaunch Chirpity to see changes, also, language settings will need to be re-set manually">?</a>
                        </div>
                    </div>
                </fieldset>
            </form>                        
        </div>
    </div>      
    <!-- The modal for the tour -->
    <div class="modal modal-fade" id="tourModal" tabindex="-1" aria-labelledby="tourModalLabel" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="carouselExample" class="carousel carousel-dark slide" data-bs-ride="false"
                    data-bs-wrap="false">
                    <!-- Carousel indicators -->
                    <ol class="carousel-indicators">
                        <li data-bs-target="#carouselExample" data-bs-slide-to="0" class="active"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="1"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="2"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="3"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="4"></li>
                        <!-- Add more indicators as needed -->
                    </ol>
                    <div class="carousel-inner" style="min-height: 400px;">
                        <!-- Carousel items -->
                        <div class="carousel-item active">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Welcome to Chirpity Nocmig</h5>
                                <p>This tour will highlight a few of the key features of the application. Click the right arrow for the next item</p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#navbarSettings">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-start pb-4 ms-3">
                                <h5 class="text-center">Getting Started</h5>
                                <ol class="ps-5 ms-5">
                                    <li>First off, set your location in the settings menu.</li>
                                    <li>Next, consider which model best suits your needs:</li>
                                    <ul>
                                        <li><b>Nocmig</b> is tuned for nocturnal migration,<br> but only has birds on the British list</li>
                                        <li><b>BirdNET</b> is trained on global bird species</li>
                                    </ul>
                                </ol>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#filter-panel">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Quick access settings panel</h5>
                                <p>The icons here allow you to quickly toggle some frequently used settings.</p>
                                These include:
                                <div class="w-75 ms-5">
                                    <ol class="text-start ps-5"> 
                                        <li>Nocmig mode</li>
                                        <li>Audio filters</li>
                                        <li>Context-aware mode (Nocmig model only)</li>
                                        <li>Frequency range adjustment for the spectrogram</li>
                                        <li>Which detection list to use</li>
                                        <li>And the confidence threshold</li>
                                    </ol>
                                </div>
                                <p>Explanations for each of these settings can be found under "Settings" in the Help menu.</p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#fileContainer">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Context Menus</h5>
                                <p>Most of the tools can be accessed within context menus. These pop up when you
                                    right-click the mouse.
                                    There are context menus for detections, selected regions on the spectrogram and
                                    the filename.
                                </p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#navbarRecords">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Saved Records</h5>
                                <p>You can save records for future reference from the Records menu. Here you will
                                    also find the Chart and Explore
                                    sections of the Application. These allow you to revisit the detections you have
                                    saved and view charts of species'
                                    occurrence over time </p>
                                </div>
                            </div>
                            <!-- Add more carousel items as needed -->
                        </div>
                        <!-- Carousel navigation controls -->
                        <a class="carousel-control-prev" href="#carouselExample" role="button" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carouselExample" role="button" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </a>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-tour">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Navigation bar -->
    <div id="navPadding" class="position-absolute top-0 w-100">
        <nav class="navbar navbar-expand navbar-dark bg-dark" id="primary_nav_wrap">
            <div class="container-fluid">
            <div id="main_nav">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navBarFile" data-bs-toggle="dropdown">
                            File
                        </a>
                        <ul class="dropdown-menu">
                            <li id="open-file" class="dropdown-item">
                                <span class="material-symbols-outlined">file_open</span> Open Audio
                                File(s) <span class="shortcut float-end">Ctrl+O</span>
                            </li>
                            <li id="open-folder" class="dropdown-item">
                                <span class="material-symbols-outlined">folder_open</span> Open 
                                Folder(s)
                            </li>
                            <div class="dropdown-divider"></div>
                            <li class="dropdown-item disabled" id="saveCSV">
                                <span class="material-symbols-outlined">ios_share</span> Export Results
                                to CSV
                            </li>
                            <li class="dropdown-item disabled" id="save-summary">
                                <span class="material-symbols-outlined">ios_share</span> Export Summary
                                to CSV
                            </li>
                            <li class="dropdown-item disabled" id="save-eBird">
                                <span class="material-symbols-outlined">ios_share</span> Export eBird Record file
                            </li>
                            <li class="dropdown-item disabled" id="save-Raven">
                                <span class="material-symbols-outlined">ios_share</span> Export Raven Selection Table
                            </li>
                            <li class="dropdown-item disabled" id="export-audio">
                                <span class="material-symbols-outlined">music_note</span> Export Selected
                                Audio <span class="shortcut float-end">Ctrl+E</span>
                            </li>
                            <li class="dropdown-item disabled" id="saveLabels">
                                <span class="material-symbols-outlined">label</span> Save Audacity
                                Labels
                            </li>
                            <div class="dropdown-divider"></div>
                            <div class="row ms-0 me-0">
                                <li class="dropdown-item d-flex locked disabled col" id="import-csv">
                                    <span class="material-symbols-outlined pe-1">place_item</span> Import Results from CSV
                                    <span class="padlock col" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-title="Feature Locked" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                            <span class="pointer locked material-symbols-outlined float-end mt-1">lock</span>
                                    </span>
                                </li>
                            </div>   
                            <li><div class="dropdown-divider"></div></li>
                            <li class="dropdown-item" id="exit">
                                <span class="material-symbols-outlined">highlight_off</span> Exit
                            </li>
                        </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarRecords" role="button"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Records</a>
                        <ul class="dropdown-menu" aria-labelledby="navbarRecords">
                            <li class="dropdown-item disabled" id="save2db">
                                <span class="material-symbols-outlined">archive</span> Save to Archive
                                <span class="shortcut float-end">Ctrl+S</span>
                            </li>
                            <li class="dropdown-divider"></li>
                            <li class="dropdown-item" id="manage-locations">
                                <span class="material-symbols-outlined">edit_location_alt</span> Manage locations
                            </li>
                            <li class="dropdown-item disabled" id="charts">
                                <span class="material-symbols-outlined">assessment</span> View charts
                            </li>
                            <li class="dropdown-item disabled" id="explore">
                                <span class="material-symbols-outlined">explore</span> Explore Archive
                            </li>
                            <li class="dropdown-item disabled" id="active-analysis">
                                <span class="material-symbols-outlined">youtube_searched_for</span> Return to Active Analysis
                            </li>
                            <li class="dropdown-divider"></li>
                            <li class="dropdown-item disabled" id="compress-and-organise">
                                <span class="material-symbols-outlined">compress</span> Save Audio from Archive Results to Library
                            </li>
                            <li class="dropdown-item disabled" id="purge-file">
                                <span class="material-symbols-outlined">unarchive</span> Remove Current File From
                                Archive
                            </li>
                            <!-- <li class="dropdown-item d-none" id="dataset">
                                <span class="material-symbols-outlined">dataset</span> Create Dataset
                            </li> -->
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarAnalysis" role="button"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Analysis</a>
                    <ul class="dropdown-menu" aria-labelledby="navbarAnalysis">
                        <li class="dropdown-item disabled" id="analyse">
                            <span class="material-symbols-outlined">search</span> Analyse Current File
                            <span class="shortcut float-end">Ctrl+A</span>
                        </li>
                        <li class="dropdown-item disabled" id="analyseSelection">
                            <span class="material-symbols-outlined">manage_search</span> Analyse Selected
                            Interval
                        </li>
                        <li class="dropdown-item disabled" id="analyseAll">
                            <span class="material-symbols-outlined">search</span> Analyse All Open
                            Files <span class="shortcut float-end">Ctrl+Shift+A</span>
                        </li>
                        <li class="dropdown-divider"></li>
                        <li class="dropdown-item disabled" id="reanalyse">
                            <span class="material-symbols-outlined">youtube_searched_for</span> Re-analyse
                            Current File
                        </li>
                        <li class="dropdown-item disabled" id="reanalyseAll">
                            <span class="material-symbols-outlined">youtube_searched_for</span> Re-analyse All
                            Open Files
                        </li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarTraining" role="button"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Training functions are only available when using the BirdNET model">
                        Train</a>
                    <ul class="dropdown-menu" aria-labelledby="navbarTraining">
                        <div class="row ms-0 me-0">
                            <li class="dropdown-item locked d-flex disabled col" id="open-training">
                                <span class="material-symbols-outlined">model_training</span> Train a Custom Model
                                <span class="padlock col" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-title="Feature Locked" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                        <span class="pointer locked material-symbols-outlined float-end mt-1">lock</span>
                                </span>
                            </li>
                        </div> 
                        <div class="row ms-0 me-0">
                            <li class="dropdown-item d-flex locked disabled col" id="import-model">
                                <span class="material-symbols-outlined pe-1">account_circle</span> Import a Custom Model
                                <span class="padlock col" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-title="Feature Locked" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                        <span class="pointer locked material-symbols-outlined float-end mt-1">lock</span>
                                </span>
                            </li>
                        </div> 
                        <div class="row ms-0 me-0">
                            <li class="dropdown-item d-flex locked disabled col" id="remove-model">
                                <span class="material-symbols-outlined pe-1">account_circle</span> Remove a Custom Model
                                <span class="padlock col" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="right" data-bs-title="Feature Locked" data-bs-sanitize="false" data-bs-html="true" data-bs-content="">
                                        <span class="pointer locked material-symbols-outlined float-end mt-1">lock</span>
                                </span>
                            </li>
                        </div>                        
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <span class="nav-link dropdown-toggle" id="navbarHelp" role="button"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Help</span>
                    <ul class="dropdown-menu" aria-labelledby="navbarHelp">
                        <li class="dropdown-item" id="usage">
                            <span class="material-symbols-outlined">help</span> Using Chirpity
                        </li>
                        <!-- <li class="dropdown-item" id="settingsHelp">
                                <span class="material-symbols-outlined">help</span> Settings
                        </li> -->
                        <li class="dropdown-item" id="keyboardHelp">
                            <span class="material-symbols-outlined">help</span> Keyboard Shortcuts
                        </li>
                        <li class="dropdown-item" id="trainingHelp">
                            <span class="material-symbols-outlined">help</span> Training settings
                        </li>
                        <li class="dropdown-item" id="startTour">
                            <span class="material-symbols-outlined">tour</span> Show Tour
                        </li>
                        <li class="dropdown-divider"></li>
                        <li class="dropdown-item" id="diagnostics">
                            <span class="material-symbols-outlined">insights</span> Diagnostics
                        </li>
                        <li class="dropdown-item" id="known-issues">
                            <span class="material-symbols-outlined">bug_report</span> Known Issues
                        </li>
                        <li class="dropdown-item" id="community">
                                <span class="material-symbols-outlined">forum</span> Join the community
                        </li>
                        <li class="dropdown-divider"></li>
                        <h6 class="fs-6 ps-3" id="FAQ">FAQs</h6>
                        <li class="dropdown-item" id="species">
                                <span class="material-symbols-outlined">help</span> What species are detected?
                        </li>
                        <li class="dropdown-item" id="eBird">
                                <span class="material-symbols-outlined">help</span> What is an eBird Record?
                        </li>
                        <li class="dropdown-divider"></li>
                        <h6 class="fs-6 ps-3" id="guides">Guides (on Github)</h6>
                        <a class="dropdown-item" id="false-positives" target="_blank" href="https://github.com/Mattk70/Chirpity-Electron/discussions/34">
                            <span class="material-symbols-outlined">menu_book</span> Handling false positives
                        </a>
                        <a class="dropdown-item" id="using-custom-lists" target="_blank" href="https://github.com/Mattk70/Chirpity-Electron/discussions/394">
                            <span class="material-symbols-outlined">menu_book</span> Using custom lists
                        </a>
                        <a class="dropdown-item" id="understanding-locations" target="_blank" href="https://github.com/Mattk70/Chirpity-Electron/discussions/543">
                            <span class="material-symbols-outlined">menu_book</span> Understanding locations
                        </a>
                        <a class="dropdown-item" id="training-custom-models" target="_blank" href="https://github.com/Mattk70/Chirpity-Electron/discussions/330">
                            <span class="material-symbols-outlined">menu_book</span> Training custom models
                        </a>
                    </ul>
                </li>
            <div class="nav-item">
                <li class="nav-link text-nowrap"  onclick="placeMap('settingsMap')" id="navbarSettings"
                data-bs-toggle="offcanvas" data-bs-target="#settings" aria-controls="settings">Settings</li>
            </div>
            </ul>
        </div>
        <div id="buy-me-coffee" class="d-none"><a href="https://www.buymeacoffee.com/matthew_kirkland" target="_blank"><img src="img/bmc.png" alt="Become a Chirpity supporter on Buy-me-a-coffee" title="Support Chirpity's ongoing development and unlock exclusive features"></a></div>
        <!-- navbar-collapse.// -->
        <a href="https://chirpity.net" title="Visit the Chirpity website" target="_blank"  id="primaryLogoLink"><img id="primaryLogo" src="img/logo/chirpity_logo2.png" alt="Chirpity bird calls: Identifying birds by sound"></a>
    </div>
        <!-- container-fluid.// -->
    </nav>
</div>

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="check-circle-fill" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
    </symbol>
    <symbol id="info-fill" viewBox="0 0 16 16">
        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
    </symbol>
    <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </symbol>
</svg>
<!-- Update alert placeholder -->
<div id="updateAlert" style="position:absolute; bottom: 30px;"></div>
<div id="toastContainer" class="toast-container end-0 p-3" style="top:2rem"></div>
<!-- Footer -->
<footer class="p-1 text-bg-primary" id="footer">
    <div class="d-none text-sm-start float-start" id="update-progress"><span id="update-progress-text"></span>
        <progress value="0" id="update-progress-bar" max="100"></progress>
    </div>
    <small>Chirpity Nocmig <span id="version"></span> &copy; Matthew Kirkland <span id="year"></span></small>
</footer>
<audio id="notification">
    <source src="Help/notification.mp3" type="audio/mpeg">
</audio>
<script src="./js/ui.js" type="module"></script>
<script type="module" defer>
    import { config, displayLocationAddress, LOCATIONS, generateToast, checkCoords } from './js/ui.js';
    let map, marker, clickTimer = 0;
    let currentTileLayer = null;
    const DEFAULT_RADIUS = 30;
    const createTileLayer = () =>
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 16,
            minZoom: 1,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

    let markerGroup = null;
    let manage = false;
    const savedLocationSelect = document.getElementById('savedLocations');

    function updateForm(lat, lng) {
        const target = map.getContainer().id;

        if (target === 'settingsMap'){
            const latEl = document.getElementById('latitude')
            const lonEl = document.getElementById('longitude')
            latEl.value = lat.toFixed(4); 
            lonEl.value = lng.toFixed(4);
            const placeEl = document.getElementById('place');
            placeEl.textContent = 'Getting location...'
            displayLocationAddress(target);
        } else {
            const latEl = document.getElementById('customLat')
            const lonEl = document.getElementById('customLon')
            latEl.value = lat.toFixed(4); 
            lonEl.value = lng.toFixed(4);
            if (! savedLocationSelect.value) {
                const customPlaceEl = document.getElementById('customPlace');
                customPlaceEl.value = 'Getting location...';
                displayLocationAddress(target);
            }
        }
    }

    async function onMapClick(e) {
        const {lat, lng} = e.latlng;
        updateForm(lat, lng)
        const radius = document.getElementById('location-radius');
        const radiusDisplay = document.getElementById('radius-value');
        const currentLocation = LOCATIONS.find(loc => loc.id === parseInt(savedLocationSelect.value));
        radius.value = currentLocation ? currentLocation.radius ?? DEFAULT_RADIUS : DEFAULT_RADIUS;
        radiusDisplay.innerHTML = `<b>${radius.valueAsNumber}m</b>`;

        updateMap(lat, lng, radius.valueAsNumber);
        
        // Stop propagation of the click event to the map
        L.DomEvent.stopPropagation(e);
    }
    const showMap = (where, locationID) => {
        const addClassToMarkerIcon = (marker, className) => {
            marker.on('add', () => {
                const el = marker.getElement();
                if (el) el.classList.add(className);
            });
        };
        currentTileLayer && map.removeLayer(currentTileLayer);
        
        try {
            if (where === 'customLocationMap' && LOCATIONS.length) {
                const editSection = document.getElementById('edit-section');
                manage = !editSection.classList.contains('d-none');
                markerGroup = L.featureGroup();
                const bounds = L.latLngBounds();

                const sharedIcon = new L.Icon.Default();
                const selectedID = parseInt(savedLocationSelect.value);
                const locations = isNaN(selectedID) ? LOCATIONS : LOCATIONS.filter(loc => loc.id === selectedID);  

                for (const { id, lat, lon, radius = DEFAULT_RADIUS} of locations) {
                    const marker = L.marker([lat, lon], { icon: sharedIcon }).addTo(markerGroup);
                    const circle = L.circle([lat, lon], {
                        color: 'MidnightBlue',
                        weight: 1,
                        opacity: 0.5,
                        fillColor: 'MidnightBlue',  
                        fillOpacity: 0.2,
                        radius
                    }).addTo(markerGroup);
                    bounds.extend(marker.getLatLng());
                    if (id === 0) {
                        addClassToMarkerIcon(marker, 'leaflet-icon-default');
                    }
                    else if (id === locationID) {
                        addClassToMarkerIcon(marker, 'leaflet-icon-current');
                    }
                }
                markerGroup.addTo(map);

                if (bounds.isValid() && bounds.getNorthEast().equals(bounds.getSouthWest())) {
                    // Single point  use setView
                    map.setView(bounds.getCenter(), 12);
                } else {
                    map.fitBounds(bounds.pad(0.2));
                }

                    currentTileLayer = createTileLayer().addTo(map);
            } else {
                map.setView([config.latitude, config.longitude], 12);
                currentTileLayer = createTileLayer().addTo(map);
                markerGroup = L.featureGroup();
                const fallbackMarker = L.marker([config.latitude, config.longitude]).addTo(markerGroup);
                addClassToMarkerIcon(fallbackMarker, 'leaflet-marker-icon-default');
                markerGroup.addTo(map);
                fallbackMarker.on('click', onMapClick);
                            }
        } catch (error) {
            generateToast({ message: 'leafletError', variables: { error: error.message } });
        }
    };

    const latLonElements = ['latitude', 'longitude', 'customLat', 'customLon'];
        latLonElements.forEach(el => {
            const where = el.indexOf('custom') > -1 ? 'customLocationMap' : 'settingsMap';
            el = document.getElementById(el);
            el.addEventListener('change', () => {
                if (where === 'customLocationMap') {
                    const radius = document.getElementById('location-radius').valueAsNumber || DEFAULT_RADIUS;
                    const lat = document.getElementById('customLat').valueAsNumber;
                    const lon = document.getElementById('customLon').valueAsNumber;
                    if (checkCoords(lat, lon)) {
                        updateMap(lat, lon, radius);
                    }
                } else {
                     const lat = document.getElementById('latitude').valueAsNumber;
                    const lon = document.getElementById('longitude').valueAsNumber;
                    if (checkCoords(lat, lon)) {
                        updateMap(lat, lon);
                    }
                }
                displayLocationAddress(where, true);
            });
    })

    function updateMap(lat, lng, radius = DEFAULT_RADIUS) {
        try {
            if (! checkCoords(lat, lng)) return;
            // Remove all previous markers & circles
            markerGroup && markerGroup.remove();
            markerGroup = L.featureGroup();
            const zoom = Math.max(map.getZoom(), 14);
            const icon = new L.Icon.Default({
                className: 'leaflet-icon-current'
            });
            const draggable = true;
            const autoPan = true;

            // Marker
            const marker = L.marker([lat, lng], { icon, draggable, autoPan }).addTo(markerGroup);

            // Circle
            const circle = L.circle([lat, lng], {
                color: 'MidnightBlue',
                weight: 1,
                opacity: 0.5,
                fillColor: 'MidnightBlue',
                fillOpacity: 0.2,
                radius
            }).addTo(markerGroup);
            markerGroup.addTo(map)

            marker.on('drag', (e) => {
                const { lat, lng } = e.target.getLatLng();
                circle.setLatLng([lat, lng]);
            });
            marker.on('dragend', (e) => {
                const { lat, lng } = e.target.getLatLng();
                updateForm(lat, lng)
            });
            map.fitBounds(markerGroup.getBounds().pad(0.2), { maxZoom: zoom, animate: true });

        } catch (error) {
            generateToast({
                message: 'leafletError',
                variables: { error: error.message }
            });
            console.error(error)
        }
    }


    async function placeMap(divID, locationID){
        if (map) map?.remove();
        map = L.map(divID);
        window.map = map;
        let latTxt, lonTxt;
        if (divID === 'settingsMap'){
            latTxt = 'latitude';
            lonTxt = 'longitude';
        } else{
            latTxt = 'customLat';
            lonTxt = 'customLon';
        }
        const latEl = document.getElementById(latTxt);
        const lonEl = document.getElementById(lonTxt);
        showMap(divID, locationID);
        if (manage || divID === 'settingsMap') {
            map.on('click', (e) => {
                clearTimeout(clickTimer);
                //Wait for dblclick
                clickTimer = setTimeout(() => {onMapClick(e)}, 250);
            })

            // don't call onMapClick on dblclick
            map.on('dblclick', (e) => {
                clearTimeout(clickTimer);
            })
        }
    }

    window.placeMap = placeMap;
    window.updateMap = updateMap;
    
</script>
</body>

</html>