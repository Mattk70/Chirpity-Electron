<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https:">
    <!-- Bootstrap & CSS-->
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <script defer src="./node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <script defer src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Additional JavaScript & CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <script defer src="./node_modules/@easepick/bundle/dist/index.umd.js"></script>
    <script defer src="js/slider.js"></script>
    <script defer src="./node_modules/chart.js/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script>
        function goFullscreen(){
            const container = document.getElementById('chart-week');
            container.requestFullscreen();
        }
    </script>
    <!-- App title -->
    <title>Chirpity Bird Call Detection</title>
</head>
<body background="#ccccc">
    <!-- Loading Spinner Overlay -->
    <div id="loading" class="overlay d-none text-white">
        <div id="loadingText" class="d-flex"></div>
        <div class="d-flex justify-content-evenly">
            <div class="spinner-grow spinner-grow-sm m-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="spinner-grow spinner-grow-sm m-3" role="status" style="animation-delay: 0.5s;">
            </div>
            <div class="spinner-grow spinner-grow-sm m-3" role="status" style="animation-delay: 1s;">
            </div>
          </div>
    </div>
        <!-- DIV to Hold the spec frequency controls -->
        <div class="range_container d-none" id="frequency-range-panel">
            <fieldset class="border border-secondary rounded m-2 p-2">
                <legend class="pb-2 text-bg-dark h6">Spectrogram Frequency Range</legend>
                <div class="sliders_control">
                    <input id="fromSlider" type="range" value="0" min="0" max="11950" step="50"/>
                    <input id="toSlider" type="range" value="12000" min="0" max="11950" step="50"/>
                </div>
                <div class="form_control">
                    <div class="form_control_container">
                        <div class="form_control_container__time">Min Hz</div>
                        <input class="rounded" type="number" id="fromInput" value="0" min="0" max="11950" step="50"/>
                    </div>
                    <div class="form_control_container">
                        <div class="form_control_container__time">Max Hz</div>
                        <input class="rounded" type="number" id="toInput" value="11950" min="0" max="11950" step="50"/>
                    </div>
                    <div class="form_control_container d-flex">
                        <div class="form_control_container__time"></div>
                        <button class="btn btn-secondary disabled align-self-end pt-0 pb-0" id="reset-spec-frequency" onclick="return false">Reset</button>
                    </div>
                </div>
            </fieldset>
        </div>
    <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="settings" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header pb-2">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Settings</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" id="close-settings" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body pt-1">
            <!-- Offcanvas -->
            <form id="settingsForm" class="fs-6">
                <fieldset class="border border-secondary rounded m-2 mt-0 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Detections</legend>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Model" id="Model-circle-help"  data-bs-content="Select whether to use Chirpity, optimised for Nocturnal Migration Calls in Europe, or BirdNET, which can detect over 6000 species across the globe.">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="input-group-text col-5" for="model-to-use">Model:</label>
                            <select class="form-select mb-0" id="model-to-use">
                                <option value="chirpity">Chirpity</option>
                                <option value="birdnet">BirdNet</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Confidence Threshold" id="Confidence Threshold-circle-help"  data-bs-content="Determines the minimum confidence required for results to be returned">?</a>
                        <label for="confidence">Confidence threshold:</label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" id="confidence" min="5" max="100" step="5">
                            <div class="input-group-append">
                                <span class="input-group-text" id="confidence-value">50%</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="List" id="List-circle-help"  data-bs-content="Filters the detections returned in results. Local Birds: excludes birds 
                        unlikely to be found in your region. Nocturnal Birds: excludes bird song and species not known to call at night. The custom list allows you to upload a file listing the species to detect">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="input-group-text col-5" for="list-to-use">List:</label>
                            <select class="form-select mb-0" id="list-to-use">
                                <option value="location">Local Birds</option>
                                <option value="nocturnal">Nocturnal Birds</option>
                                <option value="birds">Birds</option>
                                <option value="everything">Everything</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="row p-2 d-none" id="choose-file-container">
                            <div class="col-10 pe-0">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" id="list-file-selector">Select file</button>
                                    <input type="text" class="form-control" id="custom-list-location" aria-describedby="list-file-selector" placeholder="No custom list set" disabled="" readonly="">
                                </div>
                            </div>
                            <div class="col ps-0 pe-4">
                                <span id="clear-custom-list" class="material-symbols-outlined btn btn-outline-secondary float-end p-1" title="Clear custom list">clear</span>
                            </div>
                        </div>
                        <div class="d-none" id="use-location-container">
                            <div class="form-switch ms-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="local">
                                <label class="form-check-label" for="local">Use Location settings</label>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Use Location settings" id="Use Location settings-circle-help"  data-bs-content="When activated, the Nocturnal birds filter reports birds based on your location settings.">?</a>
                            </div>
                        </div>
                        <div id="species-threshold-el">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Species Threshold" id="Species Threshold-circle-help"  data-bs-content="Define the minimum eBird checklist frequency for species inclusion.
                            If 'Adjust list for the week of the year' is enabled, the list will be adjusted to include species expected for the recording week.">?</a>
                            <div class="pe-3 input-group rounded p-2 mb-1">
                                <span class="input-group-text col-5">Threshold:</span>
                                <input id="species-frequency-threshold" type="number" class="form-control" style="width: 30%;" value="0.03" step="0.01" min="0.01" max="1" aria-label="species frequency threshold" aria-describedby="species-frequency-threshold">
                            </div>
                            <div class="text-nowrap mt-2"><label class="ms-2 me-2" for="species-week">Adjust list for the week of the year</label>
                                <span class="form-switch ms-2">
                                    <input id="species-week" role="switch" type="checkbox" class="form-check-input form-check-inline">
                                </span>
                            </div>                                                                
                        </div>
                    </div>
                    <div class="m-2"></div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="nocmig">
                            <label class="form-check-label" for="nocmig">Only analyse night time periods.</label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Nocmig Mode" id="Nocmig Mode-circle-help"  data-bs-content="When enabled, this 'Nocmig mode' only searches for and only displays detections found during the night">?</a>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group rounded">
                        <div class="form-check form-switch ps-2">
                            <button class="btn btn-primary" id="clear-call-cache" onclick="return false">Clear Reference Call Cache</button>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Clear Call Cache" id="Clear Call Cache-circle-help"  data-bs-content="The data used for the reference call comparisons are cached. Clearing the cache will refresh the calls for each species the next time a comparison is requested">?</a>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Default Location <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Default Location" id="Default Location-circle-help"  data-bs-content="Chirpity uses location information to determine the dawn and dusk times for recordings">?</a></legend>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="input-group">
                            <span class="input-group-text pe-2">Lat:</span>
                            <input id="latitude" type="text" class="form-control ps-2 " placeholder="0.0" aria-label="Latitude" aria-describedby="latitude">
                            <span class="input-group-text pe-2">Lon:</span>
                            <input id="longitude" type="text" class="form-control ps-2" placeholder="0.0" aria-label="Longitude" aria-describedby="longitude">
                        </div>
                        <div class="mt-1 float-end">
                            <button class="btn btn-primary" id="apply-location" onclick="return false">Set</button>
                            <button class="btn btn-secondary" id="cancel-location" onclick="return false">Cancel</button>
                        </div>
                        <div class="clearfix"></div>
                        <div id="settingsMap" class="mt-2 border border-secondary rounded"></div>
                        <div class="mt-2" id="place"></div>
                    </div>
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">System</legend>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Language" id="Language-circle-help"  data-bs-content="Select your preferred language for birds' common names">?</a>
                        <div class="pe-3 input-group rounded p-2 mb-1">
                            <label class="input-group-text col-5" for="locale">Language:</label>
                            <select class="form-select mb-0" id="locale">
                                <option value="en_uk">English (UK)</option>
                                <option value="en">English (US)</option>
                                <option value="af">Afrikaans</option>
                                <option value="ar">العربية</option>
                                <option value="cs">Čeština</option>
                                <option value="ca">Català</option>
                                <option value="da">Dansk</option>
                                <option value="de">Deutsch</option>
                                <option value="es">Español</option>
                                <option value="fi">Suomi</option>
                                <option value="fr">Français</option>
                                <option value="hu">Magyar</option>
                                <option value="it">Italiano</option>
                                <option value="ja">日本語</option>
                                <option value="ko">한국어</option>
                                <option value="nl">Nederlands</option>
                                <option value="no">Norsk</option>
                                <option value="pl">Polski</option>
                                <option value="pt">Português</option>
                                <option value="ro">Română</option>
                                <option value="ru">Русский</option>
                                <option value="sk">Slovenčina</option>
                                <option value="sl">Slovenščina</option>
                                <option value="sv">Svenska</option>
                                <option value="th">ไทย</option>
                                <option value="tr">Türkçe</option>
                                <option value="uk">Українська</option>
                                <option value="zh">中文</option>
                                <!-- <option value="custom">Custom</option> -->
                            </select>
                        </div>
                    </div>
                    <div class="p-0 chirpity-only node-only d-none">
                        <div class="form-group rounded p-2 pe-0 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Backend" id="Backend-circle-help"  data-bs-content="The webGL/webGPU backends can improve performance and reduce power consumption on some systems.">?</a>
                            <div>
                                <label class="ps-0 fs-6 text-start">Backend:</label>
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label" for="tensorflow">CPU</label>
                                    <input class="form-check-input" type="radio" name="backend" id="tensorflow" value="tensorflow" checked="">
                                </div>
                                <div class="form-check form-check-inline  no-mac">
                                    <input class="form-check-input" type="radio" name="backend" id="webgl" value="webgl">
                                    <label class="form-check-label" for="webgl">WebGL</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="backend" id="webgpu" value="webgpu">
                                    <label class="form-check-label" for="webgpu">WebGPU</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Threads" id="Threads-circle-help"  data-bs-content="The number of parallel analyses to run. By default, 
                        this is set to the number of CPU cores on the machine for fastest performance. With the GPU backend, a lower number works better e.g. 1-3">?</a>
                        <div class="form-group rounded p-2 pe-0 mb-2">
                            <label for="thread-slider">Threads:</label>
                            <div class="input-group">
                                <input type="range" class="form-control-range w-75" id="thread-slider" min="1" max="24">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="threads-value">12</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Batch Size" id="Batch Size-circle-help"  data-bs-content="Optimising the batch size can increase processing speed on longer files.">?</a>
                        <div class="form-group rounded p-2 pe-0 mb-2">
                            <label for="batch-size">Batch Size:</label>
                            <div class="input-group">
                                <input type="range" class="form-control-range w-75" id="batch-size" min="0" max="7">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="batch-size-value">2</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Audio notification" id="Audio notification-circle-help"  data-bs-content="When enabled, there will be a system notification when analyses that take over thirty seconds are finished.">?</a>
                        <div class="pe-3 form-group rounded p-2 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="audio-notification">
                                <label class="form-check-label" for="audio-notification">Enable analysis completion notifications</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Prevent system sleep" id="Prevent system sleep-circle-help"  data-bs-content="When enabled, prevent the system from suspending whilst Chirpity is in use.">?</a>
                        <div class="pe-3 form-group rounded p-2 mb-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="power-save-block">
                                <label class="form-check-label" for="power-save-block">Prevent system sleep</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Adjust font size" id="Adjust font size-circle-help"  data-bs-content="Change the global font size settings for the application.">?</a>
                        <div class="pe-3 form-group rounded p-2 mb-2">
                                Adjust font size: 
                                <span  id="decreaseFont" class="material-symbols-outlined btn btn-outline-secondary p-1">text_decrease</span> 
                                <span  id="increaseFont" class="material-symbols-outlined btn btn-outline-secondary p-1">text_increase</span>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Audio Preferences</legend>
                    <div class="me-auto">
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Volume Adjustment" id="Volume Adjustment-circle-help"  data-bs-content="Adjust the volume of audio to compensate for low recording levels.">?</a>
                            <label for="gain" class="form-label">
                                Volume Adjustment:
                            </label>
                            <div class="input-group me-0 p-0">
                                <input type="range" class="form-control-range w-75" min="0" max="50" id="gain">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="gain-adjustment">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="col form-check form-switch">
                            <label class="form-check-label" for="normalise">Normalise Audio:
                                <input class="form-check-input" type="checkbox" role="switch" id="normalise">
                            </label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Normalise" id="Normalise-circle-help"  data-bs-content="When enabled, the audio you hear will be normalised, expanding the dynamic range.">?</a>
                        </div>
                    </div>
                    <div class="me-auto">
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="High Pass Filter" id="High Pass Filter-circle-help"  data-bs-content="When set, removes low frequency noise below the threshold. If enabled before analysis, the modified audio is sent to the model. If only enabled after analysis, this just affects audio playback">?</a>
                            <label for="HighPassFrequency" class="form-label">
                                High Pass filter:
                            </label>
                            <div class="input-group me-0 p-0">
                                <input type="range" class="form-control-range w-75" min="0" max="2500" step="25" id="HighPassFrequency">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="HP-threshold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group rounded p-2 me-0 mb-2">
                        <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Low Shelf Filter" id="Low Shelf Filter-circle-help"  data-bs-content="When used, attenuates low frequency noise below the frequency threshold. If enabled before analysis, the modified audio is sent to the model. If only enabled after analysis, this just affects audio playback">?</a>
                        <label for="lowShelfFrequency" class="form-label">
                            Low Shelf filter:
                        </label>
                        <div class="input-group me-0 p-0">
                            <input type="range" class="form-control-range w-75" min="0" max="2500" step="100" id="lowShelfFrequency">
                            <div class="input-group-append">
                                <span class="input-group-text" id="LowShelf-threshold">0</span>
                            </div>
                        </div>
                        <label for="attenuation" class="form-label">Attenuation:</label>
                        <div class="input-group me-0 p-0">
                            <input type="range" class="form-control-range w-75" min="0" max="50" id="attenuation">
                            <div class="input-group-append">
                                <span class="input-group-text" id="attenuation-threshold">0 dB</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="fs-6">Audio Export:</h6>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="format" class="input-group-text col-5">Format:</label>
                        <select class="form-select mb-0" id="format">
                            <option value="wav">WAV</option>
                            <option value="flac">FLAC</option>
                            <option value="mp3">MP3</option>
                            <!-- <option value="m4a">M4A</option> -->
                            <option value="opus">Opus</option>
                        </select>
                    </div>
                    <div id="bitrate-container" class="pe-3 input-group rounded p-2 mb-1">
                        <label for="bitrate" class="input-group-text col-5">Bitrate:</label>
                        <select class="form-select mb-0" id="bitrate">
                            <option value="320">320 kbps</option>
                            <option value="192">192 kbps</option>
                            <option value="160">160 kbps</option>
                            <option value="128">128 kbps</option>
                            <option value="96">96 kbps</option>
                        </select>
                    </div>
                    <div id="quality-container" class="pe-3 input-group rounded p-2 mb-1">
                        <label for="quality" class="input-group-text  col-6">Compression:</label>
                        <select class="form-select mb-0" id="quality">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="pe-2 form-group rounded p-2 mb-2">
                        <div class="form-check-inline w-75 form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="downmix">
                            <label class="form-check-label" for="downmix">Convert to mono</label>
                        </div>
                        <a class="ms-auto circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Down mix" id="Down mix-circle-help"  data-bs-content="When enabled, exported audio will be downmixed to mono">?</a>
                    </div>
                    <div class="form-group rounded p-2 pe-0 mb-2">
                        <div class="row pe-2">
                            <label class="col-3">Decorators: </label>
                            <div class="col-6 ">
                                <div class="form-check-inline text-nowrap">
                                    <input class="form-check-input" type="checkbox" id="padding" value="2" checked="">
                                    <label class="form-check-label" for="padding">
                                        Pad
                                    </label>
                                    <input class="form-check-input" type="checkbox" id="fade" disabled="" value="1">
                                    <label class="form-check-label" for="fade">
                                        Fade
                                    </label>
                                </div>
                            </div>
                            <div class="col-3">
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Decorators" id="Decorators-circle-help"  data-bs-content="'Pad' adds 2 seconds before and after a selection to the exported audio.
                                'Fade' adds a 1 second fade effect to the start and end of the audio">?</a>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="fs-6">Audio Library:<a class="circle new-circle me-2" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Audio Library" id="Audio Library-circle-help"  
                        data-bs-html="true" date-bs-html="true" date-bs-sanitize="false" data-bs-content="Chirpity can organise your audio into a permanent library at a location of your choice, such as a data disk or network drive. Once saved, you can remove the original files, and all records will be viewable in the application.

                        To save audio to the library, you can either go to the Records menu and choose 'Save Audio from Archive Results to Library', or enable the 'Add to Library on Save' option below.
                        
                        Files will be stored in the following structure:
                        
                        <p><code>Recording Site / Year / Month / Filename</code></p>
                        'Lossy' audio requires about 1GB of storage per 24 hours, while 'Lossless' converts files to FLAC format, preserving original fidelity, bitrate, and channels, but roughly halving the file size.">?</a></h6>
                    
                        
                        <div class="form-group rounded p-2 mb-2">
                            <div class="col form-check form-switch">
                                <label class="form-check-label" for="auto-archive">Add to Library on Save
                                    <input class="form-check-input" type="checkbox" role="switch" id="auto-archive">
                                </label>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Add to Library on Save" id="Add to Library on Save-circle-help"  data-bs-content="When enabled, audio files are added to the library location whenever detections are saved to the archive.">?</a>
                            </div>
                        </div>
                        <div class="form-group rounded p-2 mb-2">
                            <div class="col form-check form-switch">
                                <label class="form-check-label" for="library-trim">Crop Library audio to night time periods
                                    <input class="form-check-input" type="checkbox" role="switch" id="library-trim">
                                </label>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Crop Library" id="Crop Library-circle-help"  data-bs-content="When enabled, audio files containing daylight periods are cropped, so the audio is only saved for nocturnal periods.">?</a>
                            </div>
                        </div>
                        <div class="row p-2" id="choose-archive-location">
                            <div class="col">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" id="archive-location-select">Library Location:</button>
                                    <input type="text" class="form-control" id="archive-location" aria-describedby="archive-location-select" placeholder="No location set" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="input-group rounded p-2 mb-1">
                            <label for="archive-format" class="input-group-text col-5">Library Format:</label>
                            <select class="form-select mb-0" id="archive-format">
                                <option value="ogg">Lossy (recommended)</option>
                                <option value="flac">Lossless</option>
                            </select>
                            
                        </div>
                    
                </fieldset>
                <fieldset class="border border-secondary rounded m-2 mb-0 p-2">
                    <legend style="font-size: large;font-weight:bold">Spectrogram Preferences</legend>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="col form-check form-switch">
                            <label class="form-check-label" for="spec-labels">Display frequency labels:
                                <input class="form-check-input" type="checkbox" role="switch" id="spec-labels">
                            </label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Show frequency labels" id="Show frequency labels-circle-help"  data-bs-content="When enabled, the spectrogram will display the frequency on the left side.">?</a>
                        </div>
                    </div>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="colourmap" class="input-group-text col-5">Colourmap:</label>
                        <select class="form-select mb-0" id="colourmap">
                            <option value="custom">Custom</option>
                            <option value="greys">Greyscale</option>
                            <option value="bone">Bone</option>
                            <option value="turbidity">Turbidity</option>
                            <option value="chlorophyll">Chlorophyll</option>
                            <option value="viridis">Viridis</option>
                            <option value="cdom">CDom</option>
                            <option value="temperature">Temperature</option>
                            <option value="salinity">Salinity</option>
                            <option value="inferno">Inferno</option>
                            <option value="magma">Magma</option>
                            <option value="plasma">Plasma</option>
                            <option value="hot">Hot</option>
                            <option value="blackbody">Blackbody</option>
                        </select>
                    </div>
                    <fieldset class="border border-secondary rounded m-2 p-2 d-none" id="colormap-fieldset">
                        <div class="mt-2">
                            <input class="form-input pointer" type="color" id="loud-color" value="#cc00ff">
                            <label class="form-label pointer" for="loud-color">Peak colour</label><br>
                            <input class="form-input pointer" type="color" id="mid-color" value="#000000">
                            <label class="form-label pointer" for="mid-color">Mid colour</label><br>
                            <input class="form-input pointer" type="color" id="quiet-color" value="#000000">
                            <label class="form-label pointer" for="quiet-color">Quiet colour</label>
                        </div>
                        <label for="color-threshold-slider" class="form-label">
                            Mid Position:
                        </label>
                        <div class="input-group">
                            <input type="range" class="form-control-range w-75" min="0" max="1" step="0.01" id="color-threshold-slider">
                            <div class="input-group-append">
                                <span class="input-group-text" id="color-threshold">0.5</span>
                            </div>
                        </div>
                    </fieldset>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="window-function" class="input-group-text col-5">Window function:</label>
                        <select class="form-select mb-0" id="window-function">
                            <option value="bartlett">Bartlett</option>
                            <option value="bartlettHann">BartlettHann</option>
                            <option value="blackman">Blackman</option>
                            <option value="cosine">Cosine</option>
                            <option value="gauss">Gauss</option>
                            <option value="hamming">Hamming</option>
                            <option value="hann">Hann</option>
                            <option value="lanczoz">Lanczoz</option>
                            <option value="rectangular">Rectangular</option>
                            <option value="triangular">Triangular</option>
                        </select>
                    </div>
                    <div class="pe-3 input-group rounded p-2 mb-1">
                        <label for="timelineSetting" class="input-group-text col-5">Timeline:</label>
                        <select class="form-select mb-0" id="timelineSetting">
                            <option value="timecode">Timecode</option>
                            <option value="timeOfDay">Time of day</option>
                        </select>
                    </div>
                </fieldset>

                <fieldset class="border border-secondary rounded m-2 p-2">
                    <legend class="pb-2" style="font-size: large;font-weight:bold;">Advanced</legend>
                    <div class="form-group rounded p-2 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="send-filtered-audio-to-model">
                            <label class="form-check-label" for="send-filtered-audio-to-model">
                                Send Filtered Audio for Analysis
                            </label>
                            <a class="circle text-bg-danger" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Send Filtered Audio" id="Send Filtered Audio-circle-help"  data-bs-content="Sending High Pass or Low Shelf filtered audio to a model will usually have a negative impact on its accuracy. Use this option with caution!">?</a>
                        </div>
                    </div>
                    <div class="chirpity-only form-group rounded p-2 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="context">
                            <label class="form-check-label" for="context">
                                Context mode
                            </label>
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Context Mode" id="Context Mode-circle-help"  data-bs-content="When enabled, context mode adapts predictions by analysing the surrounding context.
                            Not available in the BirdNET model">?</a>
                        </div>
                    </div>
                    <div class="chirpity-only me-auto">
                        <div class="form-group rounded p-2 mb-2">
                            <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Signal to Noise Ratio" id="Signal to Noise Ratio-circle-help"  data-bs-content="Skip over portions of audio with just background noise. Higher values skip increasingly noisy segments.
                            Not available in the BirdNET model">?</a>
                            <label for="snrValue" class="form-label">
                                SNR filter:
                            </label>
                            <div class="input-group">
                                <input type="range" class="form-control-range w-75" min="0" max="10" step="0.5" id="snrValue">
                                <div class="input-group-append">
                                    <span class="input-group-text" id="SNR-threshold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class=" col-auto form-group rounded p-2 mb-2">
                        <div class="text-nowrap">   
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="debug-mode">
                                <label class="form-check-label me-2" for="debug-mode">Debug mode</label><a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Debug Mode" id="Debug Mode-circle-help"  data-bs-content="Enter debug mode (changes to this setting require a Chirpity relaunch to take effect)">?</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto form-group rounded p-2 mb-2">
                        <div class="text-nowrap">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="do-not-track">
                                <label class="form-check-label me-2" for="do-not-track">Opt out of usage analytics</label><a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Disable Tracking" id="Disable Tracking-circle-help"  data-bs-content="Chirpity collects anonymous system data to enhance user experience and aid bug tracking. If you do not want to share this information, you can disable it here.">?</a>
                            </div>        
                        </div>
                    </div>
                    <div class="col-auto form-group rounded p-2 mb-2">
                        <div class="text-nowrap">
                            <div class="form-check form-switch">
                                <button class="btn btn-warning" id="reset-defaults" onclick="return false">Reset to default settings</button>
                                <a class="circle" tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Default Settings" id="Default Settings-circle-help"  data-bs-content="Reset the configuration settings to their default values. N.B. Relaunch Chirpity to see changes, also, language settings will need to be re-set manually">?</a>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </form>                        
        </div>
    </div>      
    <!-- The modal for the tour -->
    <div class="modal modal-fade" id="tourModal" tabindex="-1" aria-labelledby="tourModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="carouselExample" class="carousel carousel-dark slide" data-bs-ride="false"
                    data-bs-wrap="false">
                    <!-- Carousel indicators -->
                    <ol class="carousel-indicators">
                        <li data-bs-target="#carouselExample" data-bs-slide-to="0" class="active"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="1"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="2"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="3"></li>
                        <li data-bs-target="#carouselExample" data-bs-slide-to="4"></li>
                        <!-- Add more indicators as needed -->
                    </ol>
                    <div class="carousel-inner" style="min-height: 400px;">
                        <!-- Carousel items -->
                        <div class="carousel-item active">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Welcome to Chirpity Nocmig</h5>
                                <p>This tour will highlight a few of the key features of the application. Click the right arrow for the next item</p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#navbarSettings">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-start pb-4 ms-3">
                                <h5 class="text-center">Getting Started</h5>
                                <ol class="ps-5 ms-5">
                                    <li>First off, set your location in the settings menu.</li>
                                    <li>Next, consider which model best suits your needs:</li>
                                    <ul>
                                        <li><b>Chirpity</b> is tuned for nocturnal migration,<br> but only has birds on the British list</li>
                                        <li><b>BirdNET</b> is trained on global bird species</li>
                                    </ul>
                                </ol>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#filter-panel">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Quick access settings panel</h5>
                                <p>The icons here allow you to quickly toggle some frequently used settings.</p>
                                These include:
                                <div class="w-75 ms-5">
                                    <ol class="text-start ps-5"> 
                                        <li>Nocmig mode</li>
                                        <li>Audio filters</li>
                                        <li>Context-aware mode (Chirpity model only)</li>
                                        <li>Frequency range adjustment for the spectrogram</li>
                                        <li>Which detection list to use</li>
                                        <li>And the confidence threshold</li>
                                    </ol>
                                </div>
                                <p>Explanations for each of these settings can be found under "Settings" in the Help menu.</p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#fileContainer">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Context Menus</h5>
                                <p>Most of the tools can be accessed within context menus. These pop up when you
                                    right-click the mouse.
                                    There are context menus for detections, selected regions on the spectrogram and
                                    the filename.
                                </p>
                            </div>
                        </div>
                        <div class="carousel-item" data-element-selector="#navbarRecords">
                            <img src="img/logo/chirpity_logo2.png" class="w-100 rounded pb-4" alt="Chirpity Nocmig">
                            <div class="text-center pb-4">
                                <h5>Saved Records</h5>
                                <p>You can save records for future reference from the Records menu. Here you will
                                    also find the Chart and Explore
                                    sections of the Application. These allow you to revisit the detections you have
                                    saved and view charts of species'
                                    occurrence over time </p>
                                </div>
                            </div>
                            <!-- Add more carousel items as needed -->
                        </div>
                        <!-- Carousel navigation controls -->
                        <a class="carousel-control-prev" href="#carouselExample" role="button" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carouselExample" role="button" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </a>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Navigation bar -->
    <div id="navPadding" class="position-absolute top-0 w-100">
        <nav class="navbar navbar-expand navbar-dark bg-dark" id="primary_nav_wrap">
            <div class="container-fluid">
            <div id="main_nav">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navBarFile" data-bs-toggle="dropdown">
                            File
                        </a>
                        <ul class="dropdown-menu">
                            <li><a id="open-file" class="dropdown-item" href="#">
                                <span class="material-symbols-outlined">file_open</span> Open Audio
                                File(s) <span class="shortcut float-end">Ctrl+O</span></a>
                            </li>
                            <li><a id="open-folder" class="dropdown-item" href="#">
                                <span class="material-symbols-outlined">folder_open</span> Open 
                                Folder(s)</a>
                            </li>
                            <div class="dropdown-divider"></div>
                            <li><a class="dropdown-item disabled" id="saveCSV" href="#">
                                <span class="material-symbols-outlined">ios_share</span> Export Results
                                to CSV</a>
                            </li>
                            <li><a class="dropdown-item disabled" id="save-eBird" href="#">
                                <span class="material-symbols-outlined">ios_share</span> Export eBird Record file</a>
                            </li>
                            <li><a class="dropdown-item disabled" id="save-Raven" href="#">
                                <span class="material-symbols-outlined">ios_share</span> Export Raven Selection Table</a>
                            </li>
                            <li><a class="dropdown-item disabled" id="export-audio" href="#">
                                <span class="material-symbols-outlined">music_note</span> Export Selected
                                Audio <span class="shortcut float-end">Ctrl+E</span></a>
                            </li>
                            <li><a class="dropdown-item disabled" id="saveLabels" href="#">
                                <span class="material-symbols-outlined">label</span> Save Audacity
                                Labels</a>
                            </li>
                            <div class="dropdown-divider"></div>
                            <li><a class="dropdown-item" href="#" id="exit">
                                <span class="material-symbols-outlined">highlight_off</span> Exit</a>
                            </li>
                        </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarRecords" role="button"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Records
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarRecords">
                            <li class="dropdown-item disabled" id="save2db">
                                <span class="material-symbols-outlined">archive</span> Save to Archive
                                <span class="shortcut float-end">Ctrl+S</span>
                            </li>
                            <li class="dropdown-divider"></li>
                            <li class="dropdown-item disabled" id="charts">
                                <span class="material-symbols-outlined">assessment</span> View charts
                            </li>
                            <li class="dropdown-item disabled" id="explore">
                                <span class="material-symbols-outlined">explore</span> Explore Archive
                            </li>
                            <li class="dropdown-item d-none" id="restore">
                                <span class="material-symbols-outlined">youtube_searched_for</span> Restore Latest Analysis
                            </li>
                            <li class="dropdown-divider"></li>
                            <li class="dropdown-item disabled" id="compress-and-organise">
                                <span class="material-symbols-outlined">compress</span> Save Audio from Archive Results to Library
                            </li>
                            <li class="dropdown-item disabled" id="purge-file">
                                <span class="material-symbols-outlined">unarchive</span> Remove Current File From
                                Archive
                            </li>
                            <li class="dropdown-item d-none" id="dataset">
                                <span class="material-symbols-outlined">dataset</span> Create Dataset
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarAnalysis" role="button"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Analysis
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarAnalysis">
                        <li><a class="dropdown-item disabled" href="#" id="analyse">
                            <span class="material-symbols-outlined">search</span> Analyse Current File
                            <span class="shortcut float-end">Ctrl+A</span> </a></li>
                            <li><a class="dropdown-item disabled" href="#" id="analyseSelection">
                                <span class="material-symbols-outlined">manage_search</span> Analyse Selected
                                Interval</a></li>
                                <li><a class="dropdown-item disabled" href="#" id="analyseAll">
                                    <span class="material-symbols-outlined">search</span> Analyse All Open
                                    Files <span class="shortcut float-end">Ctrl+Shift+A</span></a>
                                </li>
                                <li class="dropdown-divider"></li>
                                <li><a class="dropdown-item disabled" href="#" id="reanalyse">
                                    <span class="material-symbols-outlined">youtube_searched_for</span> Re-analyse
                                    Current File</a></li>
                                    <li><a class="dropdown-item disabled" href="#" id="reanalyseAll">
                                        <span class="material-symbols-outlined">youtube_searched_for</span> Re-analyse All
                                        Open Files</a></li>
                                    </ul>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="navbarHelp" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Help
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="navBarHelp">
                                    <li><a class="dropdown-item" id="usage" href="#">
                                        <span class="material-symbols-outlined">help</span> Using Chirpity</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" id="settingsHelp" href="#">
                                            <span class="material-symbols-outlined">help</span> Settings
                                        </a>
                                    </li>
                                    <li><a class="dropdown-item" id="keyboardHelp" href="#">
                                        <span class="material-symbols-outlined">help</span> Keyboard Shortcuts
                                    </a>
                                </li>
                                <li><a class="dropdown-item" id="diagnostics" href="#">
                                    <span class="material-symbols-outlined">insights</span> Diagnostics
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" id="startTour" href="#">
                                    <span class="material-symbols-outlined">tour</span> Show Tour
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" id="bugs" href="#">
                                    <span class="material-symbols-outlined">forum</span> Join the community
                                </a>
                            </li>
                            <div class="dropdown-divider"></div>
                            <h6 class="fs-6 ps-3">FAQs</h6>
                            <li>
                                <a class="dropdown-item" id="species" href="#">
                                    <span class="material-symbols-outlined">help</span> What species are detected?
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" id="eBird" href="#">
                                    <span class="material-symbols-outlined">help</span> What is an eBird Record?
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="container-fluid">
                <button class="btn btn-outline-secondary border-dark float-end text-nowrap" style="--bs-btn-padding-y: .25rem;" type="button" onclick="placeMap('settingsMap')" id="navbarSettings"
                data-bs-toggle="offcanvas" data-bs-target="#settings" aria-controls="settings">Settings <span class="material-symbols-outlined fs-5 align-middle">settings</span></button>
            </div>
            <!-- navbar-collapse.// -->
            <img id="primaryLogo" src="img/logo/chirpity_logo2.png" alt="Chirpity bird calls: Identifying birds by sound">
        </div>
        <!-- container-fluid.// -->
    </nav>
</div>
<!-- Content wrapper -->
<div id="contentWrapper">
    <!-- DIV to Hold the bird list  -->
    <div id="allSpecies" class="d-none"></div>
    <div id="seenSpecies" class="d-none"></div>
    <!-- Diagnostic Modal -->
    <div class="modal fade" id="diagnosticsModal" tabindex="-1" aria-labelledby="diagnosticsModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="diagnosticsModalLabel">Diagnostic Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="diagnosticsModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>  
    <!-- Record Entry Modal -->
    <div class="modal fade" id="record-entry-modal" tabindex="-1" aria-labelledby="record-entry-modal-label" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="record-entry-modal-label">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="record-entry-form">
                    <div id="record-entry-modal-body" class="modal-body">
                        <div class="row">
                            <div class="col-8" id="record-entry-birdlist"></div>
                            <div class="col hide-in-batch">
                                <div class="form-floating mb-3">
                                    <input type="number" id="call-count" class="form-control" min="1">
                                    <label for="call-count">Call Count</label>
                                </div>
                            </div>
                        </div>
                        <fieldset class="border  ps-3 pt-1">
                            <label for="record-label" class="text-muted" style="font-size: .75em">Call Type</label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="record-label" id="label-local" value="Local">
                                <label class="form-check-label" for="label-local">Local</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="record-label" id="label-nocmig" value="Nocmig">
                                <label class="form-check-label" for="label-nocmig">Nocmig</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="record-label" id="label-unknown" value="">
                                <label class="form-check-label" for="label-unknown">Not specified</label>
                            </div>
                        </fieldset>
                        <div class="form-floating mt-3 hide-in-batch">
                            <textarea class="form-control" id="record-comment" style="height: 200px"></textarea>
                            <label for="record-comment">Comments</label>
                            <input type="hidden" id="DBmode">
                            <input type="hidden" id="batch-mode">
                            <input type="hidden" id="original-id">
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button id="record-add" type="submit" class="btn btn-success">Add</button>
                        <button id="record-dismiss" type="button" class="btn btn-danger" data-bs-dismiss="modal">Dismiss</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="helpModalLabel">Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="helpModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Species Modal -->
    <div class="modal fade" id="speciesModal" tabindex="-1" aria-labelledby="speciesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered ">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title" id="speciesModalLabel">Current Species List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="speciesModalBody" class="modal-body"></div>
                <div class="modal-footer justify-content-evenly">
                    <button id="export-list" type="button" class="btn btn-light">Export the Included List</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Analyse selection modal -->
    <div class="modal fade" id="detectionsModal" tabindex="-1" aria-labelledby="detectionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header justify-content-center text-bg-dark">
                    <h5 class="modal-title" id="detectionsModalLabel">Audio Selection Analysis</h5>
                </div>
                <div id="detectionsModalBody" class="modal-body p-0 ">
                    <table id="selectionResults" class="text-center table w-100 align-middle">
                        <thead id="selectionResultsHead">
                            <tr class="text-bg-dark">
                                <th class="text-start timeOfDay">Time</th>
                                <th class="text-start timestamp">Position</th>
                                <th class="text-start">Species</th>
                            </tr>
                        </thead>
                        <tbody class="text-dark" id="selectionResultTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Goto Modal -->
    <div class="modal fade" id="gotoModal" tabindex="-1" aria-labelledby="gotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gotoModalLabel">Go to Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="gotoForm">
                        <div class="mb-3">
                            <label for="timeInput" class="form-label">
                                <input type="text" class="form-control" id="timeInput" name="timeInput"
                                placeholder="Enter timecode">
                                <small id="gotoHelp" class="form-text text-muted">Accepts seconds, mm:ss and
                                    hh:mm:ss.</small>
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="go">Go</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Location Modal -->
        <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Set Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="locationForm" class="fs-6">
                    <div class="modal-body">
                        <fieldset class="border rounded m-2 p-1">
                            <legend class="h6">Pick A Saved Location</legend>
                            <div class="form-group rounded p-2 mb-2 bg-light">
                                <div class="row">
                                    <div class="input-group col">
                                        <div class="form-group w-100">
                                            <label for="savedLocations"></label>
                                            <select class="form-select" id="savedLocations">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="border rounded m-2 p-1">
                            <legend class="h6">Add, Edit or Delete Location</legend>
                            <div class="form-group rounded p-2 mb-2 bg-light">
                                <div class="row">
                                    <div class="input-group col">
                                        <span class="input-group-text pe-2">Lat:</span>
                                        <input id="customLat" type="text" class="form-control ps-2"
                                        placeholder="0.0" aria-label="Latitude" aria-describedby="customLat"
                                        required>
                                        <span class="input-group-text pe-2">Lon:</span>
                                        <input id="customLon" type="text" class="form-control ps-2"
                                        placeholder="0.0" aria-label="Longitude" aria-describedby="customLon"
                                        required>
                                    </div>
                                    <div id="customLocationMap" class="mt-2 border border-secondary rounded" style="height: 200px"></div>
                                </div>
                                <div class="row">
                                    <div class="input-group col">
                                        <textarea class="mt-2 w-100" id="customPlace" spellcheck="false"
                                        maxlength="100" required>...</textarea>
                                    </div>
                                </div>
                                <div class="row d-none" id="location-batch-wrapper">
                                    <div class="input-group col mt-2">
                                        <input class="form-check-input" type="checkbox" value="" id="batchLocations">
                                        <label class="form-check-label ps-2" for="batchLocations">
                                            Update ALL open files to this location
                                        </label> 
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="set-location">Set Location</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Explore Div -->
    <div id="exploreWrapper" class="p-2 row d-none justify-content-evenly">
        <div class="col align-middle">
            <div class="btn btn-light me-2 pt-3" id="exploreRange">
                <span class="material-symbols-outlined align-bottom">date_range</span>&nbsp;
                <span>Apply a date filter</span> <span class="material-symbols-outlined float-end">expand_more</span>
            </div>
        </div>
        <div class="species-selector col" id="exploreSpeciesSearch">
            <div id="explore-list" class="explore bird-list-wrapper form-floating"></div>
        </div>
        <div class="col">
            <div id="explore-location-list" class="form-floating">
                <select spellcheck="false" class="input form-select" aria-label=".form-select"
                id="explore-locations"></select>
                <label for="explore-locations">Location</label>
            </div>
        </div>
    </div>
    <!-- context menu-->
    <div class="dropdown-menu dropdown-menu-sm" id="context-menu">
        <a class="dropdown-item play"><span class="material-symbols-outlined">play_circle</span> Play</a>
        <a class="dropdown-item" href="#" id="context-analyse-selection"><span class="material-symbols-outlined">
            search
        </span> Analyse</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item" id="create-manual-record" href="#"><span class="material-symbols-outlined">
            edit_document
        </span> Edit Record</a>
        <a class="dropdown-item" id="context-create-clip" href="#"><span class="material-symbols-outlined">
            music_note
        </span> Export Audio Clip</a>
        <a class="dropdown-item d-none" id="context-xc" href="#" target="xc">
            <img src="img/logo/XC.png" alt="" style="filter:grayscale(100%);height: 1.5em"> Explore on
            Xeno-Canto</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item d-none" id="context-delete" href="#">
                <span class="delete material-symbols-outlined">delete_forever</span> Delete Record</a>
            </div>
            <!-- End context menu -->
            <!-- Spectrogram view -->
            <div class="w-100 d-none" id="spectrogramWrapper">
                <div>
                    <div class="bg-dark border border-secondary w-100" id="timeline"></div>
                    <div class="w-100" id="spectrogram">
                    </div>
                    <div class="w-100" id="waveform"></div>
                </div>
                <!-- Controls view -->
                <div class="container-fluid p-1 text-bg-dark d-inline-flex" id="controlsWrapper" style="max-height: 50px" title="Drag to resize the Spectrogram window.">
                    <a id="guano" class="pointer pt-2 d-none" tabindex="-1" data-bs-custom-class="guano-popover" data-bs-html="true" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="File Metadata" id="File Metadata-circle-help" >
                        <span class="material-symbols-outlined"  title="Display GUANO metadata">other_admission</span></a>
                    <div id="filename" class="col-auto ps-1 overflow-visible flex-nowrap"></div>
                    <div id="unsaved-icon" class="material-symbols-outlined ms-2 me-2 text-warning pointer d-none"  tabindex="-1" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-title="Unsaved Edits" id="Unsaved Edits-circle-help"  data-bs-content="There are changes to the results that haven't been saved.">warning</div>
                    <div class="col-auto btn-group bg-dark ms-2 me-2 text-nowrap" role="group">
                        <button id="playToggle" class="p-1 pe-2 btn btn-outline-secondary" title="Play / Pause (SpaceBar)">
                            <span class="material-symbols-outlined ">play_circle</span><span
                            class="align-middle d-none d-lg-inline"> Play </span>
                            /
                            <span class="material-symbols-outlined">pause</span><span
                            class="align-middle d-none d-lg-inline-block">Pause</span>
                        </button>
                    </div>
                    <div class="col btn-group bg-dark  pe-2" role="group">
                        <button id="zoomIn" title="Zoom into the spectrogram (Keyboard Shortcut: + key)" class="btn btn-outline-secondary"
                        style="max-width: 70px">
                        <span class="material-symbols-outlined zoom">zoom_in</span>
                    </button>
                    <button id="zoomOut" title="Zoom out of the spectrogram (Keyboard Shortcut: - key)" class="btn btn-outline-secondary"
                    style="max-width: 70px"><span class="material-symbols-outlined zoom align-middle">zoom_out</span>
                </button>
            </div>
            <div id="progressDiv" class="col-2 d-none"><span id="fileNumber"></span><br>
                <progress id="progress-bar" max="100" style="width:90%"></progress>
            </div>
            <div id="complete" class="col-2 pe-2" style="display:none">
            </div>
            <div class="col pe-1">

                <div class="btn-group float-end" id="filter-panel">
                    <span style="max-width: 70px" title="Nocmig mode on" id="nocmigMode"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">nights_stay</span>
                    <span style="max-width: 70px" id="audioFiltersIcon" title="Experimental audio filters applied"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">blur_on</span>
                    <span style="max-width: 70px" id="context-mode" title="Context Aware mode enabled"
                    class="chirpity-only material-symbols-outlined btn btn-outline-secondary p-1 pt-2 text-warning">swap_horiz</span>
                    <span title="Adjust spectrogram frequency range" id="frequency-range"
                    class="material-symbols-outlined btn btn-outline-secondary p-1 pt-2">vertical_align_center</span>
                    <span style="max-width: 70px" id="list-icon" class="btn btn-outline-secondary p-1"><img
                        class="icon" src="img/nocturnal.png" alt="nocturnal"></span>
                        <span style="max-width: 70px" title="Prediction confidence threshold" id="threshold-value"
                        class="btn btn-outline-secondary p-1 fs-5"><b>50%</b>
                    </span>
                    <span id="confidenceSliderContainer" class="d-none">
                        <label for="confidenceValue" class="visually-hidden">confidence</label><input type="range"
                        class="form-range vertical position-absolute" step="5" min="5" id="confidenceValue">
                    </span>
                </div>
            </div>
        </div>
    </div>
    <!-- Result container -->
    <div class="d-none" id="resultTableContainer">
        <div class="row g-0 h-100">
            <div class="col-4 h-100 overflow-auto" id="summary">
                <!-- Summary table -->
                <div id="summaryTable"></div>
            </div>
            <!-- Results table -->
            <div class="col-8 ps-1 pe-0 h-100 position-relative overflow-auto" id="resultsDiv">
                <table id="results" class="text-center table w-100 align-middle">
                    <thead id="resultsHead" class="text-bg-secondary d-none">

                    </thead>
                    <tbody class="text-dark" id="resultTableBody">
                    </tbody>
                </table>
                <nav aria-label="Identification results">
                    <ul class="m-2 pagination justify-content-center"></ul>
                </nav>
            </div>
        </div>
    </div>
    <!-- Records container -->
    <div class="d-none h-100 overflow-auto" id="recordsContainer">
        <div class="container-fluid">
            <div class="row p-1 g-1 justify-content-evenly">
                <div class="col-3 pt-4">
                    <div class="col d-none">
                        <div class="btn btn-light pt-3 mb-2" id="chartRange">
                            <span class="material-symbols-outlined align-bottom">date_range</span>&nbsp;
                            <span>Apply a date filter</span> <span
                            class="material-symbols-outlined  align-bottom">expand_more</span>
                        </div>
                    </div>
                    <div class="col mb-2">
                        <div id="speciesSearch" class="species-selector">
                            <div id="chart-list" class="chart bird-list-wrapper form-floating"></div>
                        </div>
                    </div>
                    <div class="col d-none">
                        <div id="chart-location-list" class="form-floating">
                            <select spellcheck="false" class="input form-select mb-3" aria-label=".form-select"
                            id="chart-locations"></select>
                            <label for="explore-locations">Location</label>
                        </div>
                    </div>
                    <div class="col d-none">
                        <fieldset class="border border rounded bg-light p-2">
                            <legend class="h6">Sum Detections by:</legend>
                            <div class="form-row">
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="showTotals" id="hourTotal" value="Hour">
                                    <label class="form-check-label" for="hourTotal">Hour</label>
                                </div>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="showTotals" id="dayTotal" value="Day">
                                    <label class="form-check-label" for="dayTotal">Day</label>
                                </div>
                                <div class="form-check-inline pb-3">
                                    <input class="form-check-input" type="radio" name="showTotals" id="weekTotal" value="Week">
                                    <label class="form-check-label" for="weekTotal">Week</label>
                                </div>
                            </div>
                            <legend class="h6">Group Detections by:</legend>
                            <div class="form-row">
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="groupTotals" id="dayGroup" value="Day">
                                    <label class="form-check-label" for="dayGroup">Day</label>
                                </div>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="groupTotals" id="weekGroup" value="Week">
                                    <label class="form-check-label" for="weekGroup">Week</label>
                                </div>
                                <div class="form-check-inline">
                                    <input class="form-check-input" type="radio" name="groupTotals" id="monthGroup" value="Month">
                                    <label class="form-check-label" for="monthGroup">Month</label>
                                </div>
                            </div>
                            <div class="form-row pt-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" name="stackYears" id="stackYears" checked>
                                    <label class="form-check-label" for="stackYears">Stack Years</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>                            
                <div class="col-9">
                    <div class="chart-outer position-relative">
                        <span class="material-symbols-outlined text-muted" style="z-index: 2;position: absolute; top: 40px; left: 30px" title="View Fullscreen" onclick="goFullscreen()">fullscreen</span>
                        <canvas class="border border-dark rounded-3 w-100" id="chart-week"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-3"></div>
                <div id="dataRecords" class="col-9 ps-5">
                    <table class="table table-striped border border-dark rounded-border">
                        <tbody id="recordsTableBody">
                            <tr>
                                <th id="speciesName" class="text-center" colspan="6"></th>
                            </tr>
                            <tr>
                                <th>Earliest Spring Record</th>
                                <th>Latest Spring Record</th>
                                <th>Earliest Autumn Record</th>
                                <th>Latest Autumn Record</th>
                                <th>Most Calls in 24 hours</th>
                                <th class="fst-italic text-sm-start">Chart generated in:</th>
                            </tr>
                            <tr>
                                <td id="earliestSpring"></td>
                                <td id="latestSpring"></td>
                                <td id="earliestAutumn"></td>
                                <td id="latestAutumn"></td>
                                <td id="mostDetections"></td>
                                <td id="genTime"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="check-circle-fill" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
    </symbol>
    <symbol id="info-fill" viewBox="0 0 16 16">
        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
    </symbol>
    <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </symbol>
</svg>
<!-- Update alert placeholder -->
<div id="updateAlert" style="position:absolute; bottom: 30px;"></div>
<div id="toastContainer" class="toast-container end-0 p-3" style="top:2rem"></div>
<!-- Footer -->
<footer class="p-1 text-bg-primary" id="footer">
    <div class="d-none text-sm-start" id="update-progress">Downloading update: 
        <progress value="0" id="update-progress-bar" max="100" style="width:100px"></progress>
    </div>
    <small>Chirpity Nocmig &copy; Matthew Kirkland <span id="year"></span><br></small>
</footer>
<audio id="notification">
    <source src="Help/notification.mp3" type="audio/mpeg">
</audio>
<script src="node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>
<script  src="node_modules/wavesurfer.js/dist/plugin/wavesurfer.spectrogram.min.js"></script>
<script  src="node_modules/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script>
<script  src="node_modules/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
<script src="./js/ui.js" type="module"></script>
<script type="module" defer>
    import { config, displayLocationAddress, LOCATIONS, generateToast } from './js/ui.js';
    let map, marker, clickTimer = 0;
    async function onMapClick(e) {
        const {lat, lng} = e.latlng;
        const target = map.getContainer().id;
        if (target === 'settingsMap'){
            const latEl = document.getElementById('latitude')
            const lonEl = document.getElementById('longitude')
            latEl.value = lat.toFixed(4); 
            lonEl.value = lng.toFixed(4);
            const placeEl = document.getElementById('place');
            placeEl.innerHTML = 'Getting location...'
        } else {
            const latEl = document.getElementById('customLat')
            const lonEl = document.getElementById('customLon')
            latEl.value = lat.toFixed(4); 
            lonEl.value = lng.toFixed(4);
            const customPlaceEl = document.getElementById('customPlace');
            customPlaceEl.value = 'Fetching...'
        }
        updateMap(lat, lng);
        displayLocationAddress(target);
        // Stop propagation of the click event to the map
        L.DomEvent.stopPropagation(e);
    }
    const showMap = (where) => {
        if (where === 'customLocationMap' && LOCATIONS.length){
            const markerGroup = L.featureGroup(); // Create a feature group to hold the markers
            const bounds = L.latLngBounds(); // Create bounds to include all markers
            // Add default location
            const marker = L.marker([config.latitude, config.longitude]).addTo(markerGroup);
            bounds.extend(marker.getLatLng()); // Extend the bounds to include this marker
            LOCATIONS.forEach(markerData => {
                const { lat, lon } = markerData;
                const marker = L.marker([lat, lon]).addTo(markerGroup);
                bounds.extend(marker.getLatLng()); // Extend the bounds to include this marker
            });
            map.fitBounds(bounds)
            const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 15,
                minZoom: 2,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            markerGroup.addTo(map)
            const firstMarkerEl = document.querySelector('.leaflet-marker-icon')
            firstMarkerEl.classList.add('leaflet-marker-icon-default')
            markerGroup.on('click', function (e) {
                onMapClick(e)
            });
        } else{
            try {
                map.setView([config.latitude, config.longitude], 2);
                const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 15,
                    minZoom: 3,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                if (!marker) marker = L.marker([config.latitude, config.longitude]).addTo(map);
                const firstMarkerEl = document.querySelector('.leaflet-marker-icon')
                firstMarkerEl.classList.add('leaflet-marker-icon-default')
                marker.on('click', onMapClick);
            } catch (error) {
                generateToast({message: 'There was an error showing the map: '  + error.message})
            }
        }
    }
    const latLonElements = ['latitude', 'longitude', 'customLat', 'customLon'];
    latLonElements.forEach(el => {
        const where = el.indexOf('custom') > -1 ? 'customLocationMap' : 'settingsMap';
        el = document.getElementById(el);
        el.addEventListener('change', () => {
            showMap(where);
            displayLocationAddress(where);
        });
    })

    function updateMap(lat,lng){
        try {
            // Update the marker's position
            if (!marker) marker = L.marker([lat, lng]).addTo(map);
            marker.setLatLng([lat, lng]);
            // Center the map view on the new marker position
            map.setView([lat, lng]);
        } catch (error) {
            generateToast({message: 'There was an error updating the map: '  + error.message})
        }
    }

    async function placeMap(divID){
        map?.remove(); marker = undefined;
        map = L.map(divID);
        let latTxt, lonTxt;
        if (divID === 'settingsMap'){
            latTxt = 'latitude';
            lonTxt = 'longitude';
        } else{
            latTxt = 'customLat';
            lonTxt = 'customLon';
        }
        const latEl = document.getElementById(latTxt);
        const lonEl = document.getElementById(lonTxt);
        showMap(divID);
        map.on('click', (e) => {
            clearTimeout(clickTimer);
            //Wait for dblclick
            clickTimer = setTimeout(() => {onMapClick(e)}, 250);
        })
        // don't call onMapClick on dblclick
        map.on('dblclick', (e) => {
            clearTimeout(clickTimer);
        })
    }

    window.placeMap = placeMap;
    window.updateMap = updateMap;
    window.map = map;
</script>
</body>

</html>